<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂçÉËëâ‰πãÊóÖ Chiba Pro V8 (Ëá™ÂãïÊéíÂ∫èÁâà)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Noto Sans TC) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F8FAFC; 
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .soft-shadow { box-shadow: 0 4px 20px rgba(148, 163, 184, 0.15); }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); }
        .map-container iframe { width: 100%; height: 100%; border: 0; }
        
        /* Morandi Type Badges */
        .type-food { background-color: #FDF9E5; color: #AD8A7C; }
        .type-shop { background-color: #F0F4F7; color: #5B7A8D; }
        .type-spot { background-color: #E6F3F7; color: #548C9E; }
        .type-stay { background-color: #E2EFE7; color: #7B8D83; }

        /* Morandi Accents */
        .primary { background-color: #93B5C6; }
        .primaryDark { color: #5B7A8D; }
        
        /* Member Badges - Adjusted to use Morandi hues */
        .member-badge-Catty { background-color: #F0DCDC; color: #C97C7C; } 
        .member-badge-Tony { background-color: #DDE2F0; color: #7C8BC9; } 
        .member-badge-Tina { background-color: #F0E8D7; color: #C9A87C; }
        .member-badge-Anita { background-color: #EAE6F0; color: #9A7CC9; }
        
        /* Small input for quantity */
        .qty-input {
            width: 3rem;
            text-align: center;
            padding: 0.2rem 0.1rem;
            border-bottom: 1px solid #E5E7EB;
        }
        
        /* Transitions */
        .list-move,
        .list-enter-active,
        .list-leave-active {
            transition: all 0.5s ease;
        }
        .list-enter-from,
        .list-leave-to {
            opacity: 0;
            transform: translateX(30px);
        }
        .list-leave-active {
            position: absolute;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#93B5C6', /* Dusty Blue */
                        primaryDark: '#5B7A8D', /* Darker Dusty Blue */
                        textMain: '#334155'
                    }
                }
            }
        }
    </script>
</head>
<body class="text-textMain h-screen overflow-hidden flex flex-col bg-slate-50">

    <div id="app" class="flex flex-col h-full relative max-w-md mx-auto w-full bg-white shadow-2xl overflow-hidden">
        
        <!-- Loading Screen -->
        <div v-if="!isDataReady" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-[99] flex flex-col items-center justify-center">
            <i class="fa-solid fa-spinner fa-spin-pulse text-primaryDark text-4xl mb-4"></i>
            <p class="text-sm text-slate-600">Ê≠£Âú®ÂêåÊ≠•Èõ≤Á´ØË≥áÊñô...</p>
            <p v-if="!isAuthReady" class="text-xs text-slate-400 mt-2">È©óË≠âË∫´‰ªΩ‰∏≠...</p>
        </div>

        <!-- Header -->
        <header class="bg-white pt-10 pb-2 px-5 z-20 shrink-0 shadow-sm">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-2xl font-bold tracking-tight text-slate-800">Chiba Trip <span class="text-primaryDark">v8</span></h1>
                    <p class="text-xs text-slate-400 mt-0.5" v-if="selectedTab !== 'todo'">{{ currentDateDisplay }}</p>
                </div>
                <!-- Shopping Bag Button -->
                <button @click="showShoppingModal = true" class="relative p-2 rounded-full bg-slate-50 hover:bg-slate-100 transition">
                    <i class="fa-solid fa-bag-shopping text-xl text-slate-600"></i>
                    <span v-if="shoppingList.filter(i=>!i.done).length > 0" class="absolute top-0 right-0 w-4 h-4 bg-red-400 text-white text-[10px] flex items-center justify-center rounded-full font-bold">
                        {{ shoppingList.filter(i=>!i.done).length }}
                    </span>
                </button>
            </div>
            
            <!-- Collaborative Info -->
            <div class="text-[10px] text-slate-400 mb-2 flex justify-between items-center bg-slate-100/50 p-1.5 rounded-lg border border-slate-100">
                <span class="font-mono text-primaryDark">App: {{ appId.substring(0, 8) }}...</span>
                <span class="font-mono">User: {{ userId.substring(0, 8) }}...</span>
            </div>

            <!-- Tabs -->
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 pb-2 snap-x items-center">
                <div @click="selectedTab = 'todo'" 
                     class="snap-start shrink-0 flex flex-col items-center justify-center px-4 h-16 rounded-2xl transition-all border-2 cursor-pointer"
                     :class="selectedTab === 'todo' ? 'bg-slate-800 border-slate-800 text-white shadow-lg' : 'bg-white border-slate-100 text-slate-400'">
                    <span class="text-xs font-medium">Ë°åÂâç</span>
                    <i class="fa-solid fa-clipboard-check mt-1"></i>
                </div>
                <div v-for="(day, index) in dates" :key="index" @click="selectDate(index)"
                    class="snap-start shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-2xl transition-all border-2 cursor-pointer"
                    :class="(selectedTab === 'schedule' && selectedDateIndex === index) ? 'bg-primary border-primary text-white shadow-lg transform scale-105' : 'bg-white border-slate-100 text-slate-400'">
                    <span class="text-[10px] uppercase font-bold tracking-wider">{{ day.weekday }}</span>
                    <span class="text-lg font-bold">{{ day.date.split('/')[2] }}</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto hide-scrollbar bg-slate-50 relative pb-28">

            <!-- 1. Ë°åÂâç TODO -->
            <div v-if="selectedTab === 'todo'" class="p-5 space-y-4">
                <div class="bg-white rounded-3xl p-6 soft-shadow">
                    <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center">
                        <i class="fa-solid fa-list-check text-primaryDark mr-2"></i> Ë°åÂâçÊ∫ñÂÇô
                    </h2>
                    <div class="space-y-6">
                        <div v-for="(item, idx) in todoList" :key="idx" class="group border-b border-slate-50 pb-4 last:border-0">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-slate-700 font-bold">{{ item.text }}</span>
                                <button @click="removeTodo(idx)" class="text-slate-200 hover:text-red-400 transition"><i class="fa-solid fa-times"></i></button>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <label v-for="member in members" :key="member" class="flex items-center space-x-2 cursor-pointer bg-slate-50 p-2 rounded-lg hover:bg-slate-100">
                                    <input type="checkbox" v-model="item.status[member]" @change="saveData" class="w-4 h-4 rounded text-blue-500 border-slate-300">
                                    <span class="text-xs text-slate-500" :class="{'line-through opacity-50': item.status[member]}">{{ member }}</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex items-center mt-2 bg-slate-50 rounded-xl px-3 py-2">
                            <i class="fa-solid fa-plus text-slate-400 mr-2"></i>
                            <input v-model="newTodoText" @keyup.enter="addTodo" placeholder="Êñ∞Â¢ûÂæÖËæ¶‰∫ãÈ†Ö..." class="flex-1 bg-transparent outline-none text-sm text-slate-600">
                            <button @click="addTodo" class="text-primaryDark font-bold text-sm">Êñ∞Â¢û</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Ë°åÁ®ãË°® -->
            <div v-if="selectedTab === 'schedule'" class="p-5">
                <div v-if="currentDayItinerary.length === 0" class="text-center py-12 text-slate-400">
                    <div class="text-4xl mb-3">üìÖ</div>
                    <p>Êú¨Êó•ÁÑ°Ë°åÁ®ãÔºåË´ãÈªûÊìä + Êñ∞Â¢û</p>
                </div>

                <div class="space-y-0 relative pb-10">
                    <div class="absolute left-[19px] top-4 bottom-0 w-0.5 bg-slate-200 -z-10"></div>

                    <!-- Transition Group for Auto-Sorting Animation -->
                    <transition-group name="list">
                        <div v-for="(item, index) in currentDayItinerary" :key="item.id" class="relative pl-10 mb-6 group">
                            <!-- Time Dot -->
                            <div class="absolute left-0 top-5 w-10 flex justify-center z-10">
                                <div class="w-3 h-3 rounded-full border-2 border-white shadow-sm bg-primaryDark"></div>
                            </div>

                            <!-- Card -->
                            <div class="bg-white rounded-2xl p-4 soft-shadow border border-slate-50 hover:border-primary transition relative overflow-hidden">
                                <div class="flex justify-between items-start mb-2 pr-2">
                                    <div class="flex items-center space-x-2">
                                        <span class="font-bold text-primaryDark font-mono text-sm bg-primary/20 px-2 py-0.5 rounded-md">{{ item.time }}</span>
                                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center" :class="getTypeClass(item.type)">
                                            {{ getTypeIcon(item.type) }} {{ item.type }}
                                        </span>
                                    </div>
                                </div>
                                
                                <h3 class="text-lg font-bold text-slate-800 mb-1 leading-snug flex items-center">
                                    <a v-if="item.url" :href="item.url" target="_blank" class="hover:text-primaryDark hover:underline flex items-center">
                                        {{ item.location }} <i class="fa-solid fa-arrow-up-right-from-square text-[10px] ml-1.5 opacity-50"></i>
                                    </a>
                                    <span v-else>{{ item.location }}</span>
                                </h3>
                                
                                <p v-if="item.note" class="text-sm text-slate-500 leading-relaxed whitespace-pre-line mb-2">{{ item.note }}</p>
                                
                                <!-- Actions -->
                                <div class="flex justify-end space-x-3 mt-2 border-t border-slate-50 pt-2">
                                    <button @click.stop="editItem(item)" class="text-xs text-slate-400 hover:text-primaryDark font-medium"><i class="fa-regular fa-pen-to-square mr-1"></i>Á∑®ËºØ</button>
                                    <button @click.stop="deleteItem(item.id)" class="text-xs text-slate-400 hover:text-red-400 font-medium"><i class="fa-regular fa-trash-can mr-1"></i>Âà™Èô§</button>
                                </div>
                            </div>
                        </div>
                    </transition-group>
                </div>
            </div>

            <!-- 3. Âú∞Âúñ -->
            <div v-if="selectedTab === 'map'" class="h-full flex flex-col relative">
                <div class="h-3/5 w-full bg-slate-200 relative map-container">
                    <iframe :src="currentMapUrl" loading="lazy" allowfullscreen></iframe>
                    <div class="absolute bottom-4 right-4">
                         <button @click="locateMe" class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-slate-600 hover:text-primaryDark">
                            <i class="fa-solid fa-crosshairs"></i>
                        </button>
                    </div>
                </div>
                <div class="flex-1 bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] overflow-hidden flex flex-col -mt-5 relative z-10">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white">
                        <h3 class="font-bold text-slate-700">‰ªäÊó•Ë∑ØÁ∑öËàáÈáòÈÅ∏Èªû</h3>
                        <a href="https://maps.app.goo.gl/xMjXvbGtCYEqxWPKA" target="_blank" class="text-xs text-white bg-primaryDark px-3 py-1.5 rounded-lg hover:bg-primary transition shadow-lg shadow-blue-200/50 font-bold">
                            <i class="fa-solid fa-map-location-dot mr-1"></i>ÈñãÂïüÊ∏ÖÂñÆ
                        </a>
                    </div>
                    
                    <div class="overflow-y-auto p-4 space-y-2 pb-20">
                        <div v-if="currentDayItinerary.length === 0" class="text-center text-slate-400 text-sm py-4">Êú¨Êó•ÁÑ°Ë°åÁ®ãÔºåÂú∞ÂúñÂÉÖÈ°ØÁ§∫È†êË®≠ÂçÄÂüü„ÄÇ</div>
                        <div v-for="(item, idx) in currentDayItinerary" :key="idx" 
                             @click="updateMapLocation(item.location)"
                             class="flex items-center p-3 rounded-xl border border-slate-100 hover:border-primary/50 hover:bg-slate-50 transition cursor-pointer group"
                             :class="{'bg-primary/20 border-primary': currentMapLocation === item.location}">
                            <span class="w-6 h-6 rounded-full bg-slate-200 text-slate-500 text-xs flex items-center justify-center mr-3 font-mono shrink-0 group-hover:bg-primaryDark group-hover:text-white">{{ idx + 1 }}</span>
                            <div class="flex-1">
                                <div class="font-medium text-slate-700">{{ item.location }}</div>
                                <div class="text-[10px] text-slate-400 flex items-center gap-2">
                                    <span :class="getTypeClass(item.type)" class="px-1 rounded-full text-[10px] font-bold">{{ item.type }}</span>
                                </div>
                            </div>
                            <a :href="'https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(item.location)" target="_blank" class="text-primaryDark hover:text-primary p-2 rounded-full hover:bg-slate-100">
                                <i class="fa-solid fa-location-arrow"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Èå¢ÂåÖ -->
            <div v-if="selectedTab === 'wallet'" class="p-5 pb-32 space-y-6">
                <!-- Á∏ΩË¶ΩÂç°Áâá -->
                <div class="bg-gradient-to-br from-primaryDark to-slate-600 rounded-3xl p-5 text-white shadow-lg shadow-primary/50 relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <h3 class="font-bold text-lg">ÊóÖË≤ªÁ∏ΩË¶Ω (NT$)</h3>
                        <div class="text-[10px] bg-white/20 px-2 py-1 rounded backdrop-blur-sm flex items-center">
                            Visa ÂåØÁéá: {{ exchangeRate.toFixed(4) }}
                        </div>
                    </div>
                    <div class="flex items-baseline space-x-1 relative z-10">
                        <span class="text-3xl font-bold tracking-tight">${{ totalExpenseTWD.toLocaleString() }}</span>
                    </div>
                </div>

                <!-- ÂàÜ‰∫∫Áµ±Ë®à -->
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="m in members" :key="m" class="bg-white p-3 rounded-2xl soft-shadow border border-slate-50">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-bold px-2 py-0.5 rounded-md" :class="'member-badge-'+m">{{ m }}</span>
                            <span class="text-[10px] text-slate-400">Â∑≤ÊîØ‰ªòÁ∏ΩÈáëÈ°ç</span>
                        </div>
                        <div class="text-lg font-bold text-slate-700">
                            NT${{ getMemberTotal(m).toLocaleString() }}
                        </div>
                    </div>
                </div>

                <!-- ÊØèÊó•ÊòéÁ¥∞ -->
                <div class="space-y-4">
                    <div v-for="(group, dateStr) in expenseGroups" :key="dateStr" class="bg-white rounded-2xl soft-shadow overflow-hidden">
                        <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 flex justify-between items-center">
                            <span class="font-bold text-slate-600 text-sm">{{ dateStr }}</span>
                            <span class="text-xs font-mono font-bold text-slate-400">Â∞èË®à: NT$ {{ Math.round(group.totalTWD).toLocaleString() }}</span>
                        </div>
                        <div class="divide-y divide-slate-50">
                            <div v-for="(exp, idx) in group.items" :key="idx" class="p-4 hover:bg-slate-50 transition group/item">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="text-slate-700 font-medium text-sm">{{ exp.title }}</div>
                                        <div class="flex items-center space-x-2 mt-1">
                                            <span class="text-[10px] px-1.5 py-0.5 rounded font-bold" :class="'member-badge-'+exp.payer">{{ exp.payer }}</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="text-right mr-3">
                                            <div class="font-mono font-bold text-slate-700">
                                                {{ exp.currency === 'JPY' ? '¬•' : 'NT$' }}{{ parseInt(exp.amount).toLocaleString() }}
                                            </div>
                                            <div v-if="exp.currency === 'JPY'" class="text-[10px] text-slate-400">
                                                ‚âà NT${{ Math.round(exp.amount * exchangeRate).toLocaleString() }}
                                            </div>
                                        </div>
                                        <button @click="deleteExpense(exp.id)" class="w-6 h-6 rounded-full bg-red-50 text-red-400 flex items-center justify-center opacity-0 group-hover/item:opacity-100 transition">
                                            <i class="fa-solid fa-times text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- FAB -->
        <button v-if="selectedTab !== 'todo' && selectedTab !== 'map'" @click="openAddModal" class="absolute bottom-24 right-5 w-14 h-14 bg-primaryDark text-white rounded-full shadow-lg shadow-primary/50 flex items-center justify-center text-xl hover:scale-110 active:scale-95 transition z-30">
            <i class="fa-solid fa-plus"></i>
        </button>

        <!-- Nav -->
        <nav class="glass-nav absolute bottom-0 w-full pb-6 pt-3 px-6 shadow-md border-t border-white/50 flex justify-around items-center z-40 rounded-t-3xl">
            <button @click="selectedTab = 'schedule'" :class="selectedTab === 'schedule' ? 'text-primaryDark' : 'text-slate-300'" class="flex flex-col items-center w-16 transition">
                <i class="fa-solid fa-route text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Ë°åÁ®ã</span>
            </button>
            <button @click="selectedTab = 'map'" :class="selectedTab === 'map' ? 'text-primaryDark' : 'text-slate-300'" class="flex flex-col items-center w-16 transition">
                <i class="fa-solid fa-map text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Â∞éËà™</span>
            </button>
            <button @click="selectedTab = 'wallet'" :class="selectedTab === 'wallet' ? 'text-primaryDark' : 'text-slate-300'" class="flex flex-col items-center w-16 transition">
                <i class="fa-solid fa-wallet text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Ë®òÂ∏≥</span>
            </button>
        </nav>

        <!-- Modals -->
        
        <!-- Shopping Modal -->
        <div v-if="showShoppingModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4" @click.self="showShoppingModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform transition-all animate-slide-up h-[85vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-700">Ë≥ºÁâ©Ê∏ÖÂñÆ üõçÔ∏è</h3>
                    <button @click="showShoppingModal = false" class="bg-slate-100 w-8 h-8 rounded-full text-slate-500"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <!-- Filter Tabs -->
                <div class="flex overflow-x-auto hide-scrollbar space-x-2 pb-2 mb-4 shrink-0 border-b border-slate-100">
                    <button @click="shoppingFilterOwner = ''"
                            :class="shoppingFilterOwner === '' ? 'bg-primaryDark text-white' : 'bg-slate-100 text-slate-500 hover:bg-primary/20'"
                            class="shrink-0 text-xs font-bold px-3 py-1.5 rounded-xl transition">ÂÖ®ÈÉ® ({{ shoppingList.length }})</button>
                    <button v-for="m in members" :key="m"
                            @click="shoppingFilterOwner = m"
                            :class="shoppingFilterOwner === m ? 'bg-primaryDark text-white' : 'bg-slate-100 text-slate-500 hover:bg-primary/20'"
                            class="shrink-0 text-xs font-bold px-3 py-1.5 rounded-xl transition">
                            {{ m }} ({{ shoppingList.filter(i => i.owner === m).length }})
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto hide-scrollbar space-y-4 mb-4">
                    <!-- New Item Form -->
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 space-y-2">
                        <div class="flex space-x-2">
                            <input v-model="newShoppingItem.text" @keyup.enter="addShoppingItem" placeholder="ÂìÅÈ†ÖÂêçÁ®±" class="flex-1 bg-white rounded-lg px-3 py-2 outline-none text-sm">
                            <input v-model.number="newShoppingItem.price" type="number" placeholder="¬• ÂñÆÂÉπ" class="w-20 bg-white rounded-lg px-2 py-2 outline-none text-sm">
                        </div>
                        <div class="flex space-x-2">
                             <select v-model="newShoppingItem.owner" class="bg-white rounded-lg px-2 py-2 outline-none text-xs w-20 text-slate-600">
                                <option v-for="m in members" :value="m">{{ m }}</option>
                            </select>
                            <input v-model="newShoppingItem.url" placeholder="Âú∞ÈªûÈÄ£Áµê (Google Map)" class="flex-1 bg-white rounded-lg px-3 py-2 outline-none text-xs">
                        </div>
                        <div class="flex space-x-2 justify-end">
                            <button @click="addShoppingItem" class="bg-primaryDark text-white px-4 rounded-lg text-xs font-bold shadow-lg shadow-primary/50">Êñ∞Â¢û</button>
                        </div>
                    </div>

                    <!-- List -->
                    <div v-for="(item, idx) in filteredShoppingList" :key="idx" class="flex flex-col p-3 bg-slate-50 rounded-xl border border-slate-100 relative overflow-hidden">
                        <div class="flex items-start justify-between mb-1 relative z-10">
                            <div class="flex items-center flex-1">
                                <input type="checkbox" v-model="item.done" @change="saveData" class="w-5 h-5 text-blue-500 rounded border-slate-300 focus:ring-blue-500">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center space-x-2">
                                        <span class="font-medium text-slate-700" :class="{'line-through text-slate-400': item.done}">{{ item.text }}</span>
                                        <span v-if="item.owner" class="text-[10px] px-1.5 py-0.5 rounded font-bold" :class="'member-badge-'+item.owner">{{ item.owner }}</span>
                                    </div>
                                    <div class="flex items-center mt-1 space-x-3">
                                        <a v-if="item.url" :href="item.url" target="_blank" class="text-xs text-blue-400 hover:underline"><i class="fa-solid fa-location-dot"></i> Âú∞Èªû</a>
                                    </div>
                                </div>
                            </div>
                            <button @click="removeShoppingItem(idx)" class="text-slate-300 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                        <div class="flex items-center ml-8 text-xs text-slate-400 relative z-10">
                            <span class="mr-2">Êï∏Èáè:</span>
                            <input type="number" v-model.number="item.quantity" @input="saveData" min="1" class="bg-transparent qty-input border-slate-200 outline-none mx-1 text-slate-600 focus:border-primaryDark">
                            <span class="ml-4">ÂñÆÂÉπ: ¬•{{ (item.price || 0).toLocaleString() }}</span>
                            <span v-if="item.price && item.quantity > 0" class="text-primaryDark font-bold ml-2">Á∏ΩË®à: NT$ {{ Math.round(item.price * item.quantity * exchangeRate).toLocaleString() }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Total Display -->
                <div class="mt-auto pt-4 border-t border-slate-200 sticky bottom-0 bg-white z-20 rounded-b-3xl -mx-6 px-6">
                    <div class="flex justify-between items-center font-bold text-lg text-slate-700">
                        <span>Áï∂ÂâçÁ∏ΩÈáëÈ°ç (Â∑≤ÁØ©ÈÅ∏)</span>
                        <div class="text-right">
                            <span class="block text-primaryDark">¬• {{ currentFilteredShoppingTotalJPY.toLocaleString() }}</span>
                            <span class="block text-sm text-slate-500">‚âà NT$ {{ currentFilteredShoppingTotalTWD }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div v-if="showEditModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closeEditModal">
            
            <!-- Schedule Edit -->
            <div v-if="selectedTab === 'schedule'" class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold text-slate-700 mb-4">{{ modalForm.id ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }}</h3>
                <div class="space-y-4 text-sm">
                    <!-- Type Selection -->
                    <div class="grid grid-cols-4 gap-2">
                        <button v-for="t in ['È£üÁâ©', 'Ë≥ºÁâ©', 'ÊôØÈªû', '‰ΩèÂÆø']" :key="t" 
                            @click="modalForm.type = t"
                            class="py-2 rounded-xl text-xs font-bold border transition"
                            :class="modalForm.type === t ? 'bg-primaryDark text-white border-primaryDark' : 'bg-white text-slate-400 border-slate-200'">
                            {{ t }}
                        </button>
                    </div>

                    <div class="flex space-x-3">
                        <div class="flex-1">
                            <label class="text-xs text-slate-400 ml-1">ÊôÇÈñì</label>
                            <input type="time" v-model="modalForm.time" class="w-full bg-slate-50 rounded-xl px-4 py-3 outline-none text-slate-700 font-mono">
                        </div>
                        <!-- Weather Input REMOVED -->
                    </div>
                    
                    <div>
                        <label class="text-xs text-slate-400 ml-1">Âú∞ÈªûÂêçÁ®±</label>
                        <input type="text" v-model="modalForm.location" class="w-full bg-slate-50 rounded-xl px-4 py-3 outline-none text-slate-700 font-bold" placeholder="‰æãÂ¶Ç: ÁØâÂú∞Â∏ÇÂ†¥">
                    </div>

                    <div>
                        <label class="text-xs text-slate-400 ml-1">Google Map Á∂≤ÂùÄ</label>
                        <input type="text" v-model="modalForm.url" class="w-full bg-slate-50 rounded-xl px-4 py-3 outline-none text-blue-500 text-xs" placeholder="https://maps.app.goo.gl/...">
                    </div>

                    <div>
                        <label class="text-xs text-slate-400 ml-1">ÂÇôË®ª</label>
                        <textarea v-model="modalForm.note" class="w-full bg-slate-50 rounded-xl px-4 py-3 outline-none text-slate-700 h-16 resize-none"></textarea>
                    </div>
                    
                    <!-- Transport (Á∞°ÂåñÁÇ∫Â∞éËà™ÊåâÈàï) -->
                    <div class="bg-primary/20 p-4 rounded-xl border border-primary relative">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-primaryDark"><i class="fa-solid fa-route mr-1"></i>‰∫§ÈÄöÂ∞éËà™</label>
                            <button @click="openGoogleMapsRoute" class="text-[10px] bg-white text-primaryDark border border-primary px-2 py-1 rounded-full shadow-sm hover:bg-slate-100 transition flex items-center font-bold">
                                <i class="fa-solid fa-location-arrow mr-1"></i> Á´ãÂç≥Â∞éËà™
                            </button>
                        </div>
                        <p class="text-xs text-slate-600">ÈªûÊìä„ÄåÁ´ãÂç≥Â∞éËà™„ÄçÂ∞áÈñãÂïü Google Maps AppÔºå‰ª•ÊÇ®ÁöÑ**ÁõÆÂâç‰ΩçÁΩÆ**ÁÇ∫Ëµ∑Èªû„ÄÇ</p>
                    </div>
                </div>
                <button @click="saveItineraryItem" class="w-full bg-primaryDark text-white rounded-xl py-3 mt-6 font-bold shadow-lg shadow-primary/50">ÂÑ≤Â≠ò</button>
            </div>

            <!-- Expense Edit -->
            <div v-if="selectedTab === 'wallet'" class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold text-slate-700 mb-4">Ë®ò‰∏ä‰∏ÄÁ≠Ü üí∏</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-400 ml-1 mb-1 block">Ë™∞‰ªòÈå¢Ôºü</label>
                        <div class="grid grid-cols-4 gap-2">
                            <label v-for="m in members" :key="m" class="cursor-pointer text-center">
                                <input type="radio" v-model="expenseForm.payer" :value="m" class="hidden peer">
                                <div class="py-2 rounded-lg text-xs font-bold text-slate-500 bg-slate-100 peer-checked:bg-primaryDark peer-checked:text-white transition">{{ m }}</div>
                            </label>
                        </div>
                    </div>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <label class="flex-1 cursor-pointer text-center">
                            <input type="radio" v-model="expenseForm.currency" value="JPY" class="hidden peer">
                            <div class="py-2 rounded-lg text-sm font-bold text-slate-500 peer-checked:bg-primary peer-checked:text-white transition">Êó•Âπ£ (JPY)</div>
                        </label>
                        <label class="flex-1 cursor-pointer text-center">
                            <input type="radio" v-model="expenseForm.currency" value="TWD" class="hidden peer">
                            <div class="py-2 rounded-lg text-sm font-bold text-slate-500 peer-checked:bg-primary peer-checked:text-white transition">Âè∞Âπ£ (TWD)</div>
                        </label>
                    </div>
                    <div class="relative">
                        <span class="absolute left-4 top-3 text-slate-400 font-bold">{{ expenseForm.currency === 'JPY' ? '¬•' : '$' }}</span>
                        <input type="number" v-model="expenseForm.amount" placeholder="ÈáëÈ°ç" class="w-full bg-slate-50 rounded-xl pl-8 pr-4 py-3 outline-none text-xl font-bold text-slate-700 border border-slate-100 focus:border-primaryDark">
                    </div>
                    <input type="text" v-model="expenseForm.title" placeholder="È†ÖÁõÆ" class="w-full bg-slate-50 rounded-xl px-4 py-3 outline-none text-slate-700 border border-slate-100 focus:border-primaryDark">
                    <div>
                        <label class="text-xs text-slate-400 ml-1">Êó•Êúü</label>
                        <select v-model="expenseForm.date" class="w-full bg-slate-50 rounded-xl px-4 py-3 outline-none text-slate-700 border border-slate-100 focus:border-primaryDark">
                            <option v-for="d in dates" :value="d.date">{{ d.date }} ({{ d.weekday }})</option>
                        </select>
                    </div>
                </div>
                <button @click="saveExpense" class="w-full bg-primaryDark text-white rounded-xl py-3 mt-6 font-bold shadow-lg shadow-primary/50">Êñ∞Â¢ûÁ¥ÄÈåÑ</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ‰øÆÊ≠£ÂæåÁöÑ Vue Ëß£Êßã
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue; 

        // Global Firebase Configuration and Authentication Setup
        // üö® ÈÄôÊòØÊÇ®ÂµåÂÖ•ÁöÑ Firebase Config üö®
        const MANUAL_CONFIG_OBJECT = {
          apiKey: "AIzaSyALhfxIv4MsLPxjfLeOYfyG2VfeD3XjFPI",
          authDomain: "chiba-1981c.firebaseapp.com",
          projectId: "chiba-1981c",
          storageBucket: "chiba-1981c.firebasestorage.app",
          messagingSenderId: "361035054636",
          appId: "1:361035054636:web:2d682857fd8399dc651b89",
          measurementId: "G-QZLJQ7Q2RQ"
        };
        // üö® ÂµåÂÖ•ÁµêÊùü üö®

        const appId = 'Chiba-Travel-App'; // ‰ΩøÁî®Â∞àÊ°àÂêçÁ®±‰ΩúÁÇ∫ÂÖ¨Èñã ID
        const firebaseConfig = MANUAL_CONFIG_OBJECT || (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let tripDocRef;

        const initializeFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config not found. Please ensure MANUAL_CONFIG_OBJECT is set correctly.");
                return { db: null, auth: null, userId: 'CONFIG_MISSING' };
            }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            try {
                // ‰øÆÊ≠£ÔºöÁï∂‰ΩøÁî®ÊâãÂãïÈÖçÁΩÆ (Github Pages) ÊôÇÔºåÂº∑Âà∂‰ΩøÁî®ÂåøÂêçÁôªÂÖ•ÔºåÂøΩÁï• Canvas Áí∞Â¢É Token
                if (MANUAL_CONFIG_OBJECT) {
                     await signInAnonymously(auth);
                } else if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                const userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase Auth Successful. User ID:", userId);
                
                // Use a public path for collaborative data
                tripDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', 'chiba_trip_data');

                return { db, auth, userId };
            } catch (error) {
                console.error("Firebase Auth Failed:", error);
                // Fallback userId if auth fails
                return { db, auth, userId: 'anon-' + crypto.randomUUID().substring(0, 8) };
            }
        };

        createApp({
            setup() {
                // --- Configuration & Constants ---
                const members = ['Catty', 'Tony', 'Tina', 'Anita'];
                const CITY_MAP = {
                    'Ê°ÉÂúí': { name: 'Taoyuan, TW', min: 18, max: 25 },
                    'ÊàêÁî∞': { name: 'Narita, JP', min: 5, max: 13 },
                    'ÂçÉËëâ': { name: 'Chiba, JP', min: 5, max: 13 },
                    'ÁØâÂú∞': { name: 'Tokyo, JP', min: 5, max: 13 },
                    'Êù±‰∫¨': { name: 'Tokyo, JP', min: 5, max: 13 },
                    '‰ΩêÂéü': { name: 'Katori, JP', min: 4, max: 12 },
                    'ÈÖíÈÖí‰∫ï': { name: 'Shisui, JP', min: 5, max: 13 },
                    'Richmond': { name: 'Narita, JP', min: 5, max: 13 },
                    'Hotel': { name: 'Chiba, JP', min: 5, max: 13 }
                };
                const weatherCache = {};
                
                // --- Reactive State ---
                const selectedTab = ref('schedule');
                const selectedDateIndex = ref(0);
                const showShoppingModal = ref(false);
                const showEditModal = ref(false);
                const exchangeRate = ref(0.218); 
                const currentMapLocation = ref('');
                const shoppingFilterOwner = ref(''); 
                
                // Firebase/Data Status
                const isAuthReady = ref(false);
                const isDataReady = ref(false);
                const userId = ref('...');

                // *** DATES ARRAY ***
                const dates = [
                    { date: '2025/12/18', weekday: 'ÈÄ±Âõõ' },
                    { date: '2025/12/19', weekday: 'ÈÄ±‰∫î' },
                    { date: '2025/12/20', weekday: 'ÈÄ±ÂÖ≠' },
                    { date: '2025/12/21', weekday: 'ÈÄ±Êó•' },
                    { date: '2025/12/22', weekday: 'ÈÄ±‰∏Ä' },
                ];
                
                // Data references (synced with Firestore)
                const itinerary = ref([]);
                const expenses = ref([]);
                const todoList = ref([]);
                const shoppingList = ref([]);
                
                // Initial Default Data
                const getDefaultData = () => ({
                    itinerary: [
                        { id: 1, date: '2025/12/18', time: '02:30', location: 'Ê°ÉÂúíÁ¨¨‰∏ÄËà™Âªà', type: 'ÊôØÈªû', url: '', note: 'Ëà™Áè≠GK12ÔºåÈ†êË®Ç‰ª£ËôüÔºöNSFJ3H', weather: 'sunny', temp: 20 },
                        { id: 2, date: '2025/12/18', time: '06:35', location: 'ÊàêÁî∞Á¨¨‰∏âËà™Âªà', type: 'ÊôØÈªû', url: '', note: 'ÈôçËêΩÔºåÂá∫ÈóúÂæåÊ¥óÊº±ÂåñÂ¶ùÊèõË£ù„ÄÇÁ¥ÄÂøµÁ´†Âú®T1 5F/JRÊúçÂãôËôï', weather: 'cloudy', temp: 8 },
                        { id: 3, date: '2025/12/18', time: '08:04', location: 'JRÂçÉËëâÁ´ô', type: 'ÊôØÈªû', url: '', note: 'Ëá≥Á¨¨‰∫åËà™ÂªàÊê≠ÊàêÁî∞Á∑ö7:25Êàñ8:04„ÄÇ', weather: 'sunny', temp: 10 },
                        { id: 4, date: '2025/12/18', time: '09:00', location: 'Hotel Shuranza CHIBA', type: '‰ΩèÂÆø', url: '', note: 'Ëµ∞900ÂÖ¨Â∞∫ÂØÑÊîæË°åÊùé„ÄÇ', weather: 'sunny', temp: 11 },
                        { id: 5, date: '2025/12/18', time: '10:00', location: 'ÂÆ¢Â§öÁæéÂíñÂï°', type: 'È£üÁâ©', url: '', note: 'Êó©È§ê„ÄÇ', weather: 'sunny', temp: 12 },
                        { id: 6, date: '2025/12/18', time: '14:00', location: 'ÂçÉËëâÁ´ôÈÄ±ÈÇäË≥ºÁâ©', type: 'Ë≥ºÁâ©', url: '', note: 'UQ„ÄÅGU„ÄÅMUJI„ÄÅ3COINS„ÄÅWEGO‚ãØ', weather: 'sunny', temp: 13 },
                        { id: 7, date: '2025/12/18', time: '18:00', location: 'ÂçÉËëâÊ∏Ø‰πãÂ°î', type: 'ÊôØÈªû', url: '', note: 'ÁúãÁáàÂÖâÁßÄ(‰∏ÄÂπ¥‰∏ÄÊ¨°ÔºåÈúÄÁ¢∫Ë™ç)„ÄÇ', weather: 'cloudy', temp: 9 },
                        { id: 8, date: '2025/12/18', time: '20:00', location: 'ÂîêÂêâËªªÂæ∑', type: 'Ë≥ºÁâ©', url: '', note: '24Â∞èÊôÇÔºü', weather: 'cloudy', temp: 8 },
                        
                        { id: 9, date: '2025/12/19', time: '08:30', location: 'ÁØâÂú∞Â†¥Â§ñÂ∏ÇÂ†¥', type: 'È£üÁâ©', url: '', note: '6:00~14:00„ÄÇÂª∫Ë≠∞9-14ÈªûÂâçÂæÄÔºåÂ§öÊï∏ÁèæÈáë„ÄÇÂãøÈÇäËµ∞ÈÇäÂêÉÔºÅ', weather: 'rain', temp: 7 },
                        { id: 10, date: '2025/12/19', time: '14:00', location: 'Â§ñËãëÈäÄÊùè‰∏¶Êú®', type: 'ÊôØÈªû', url: '', note: 'ÂèØÁúãÊ•ìËëâ+ÈäÄÊùè„ÄÇ', weather: 'sunny', temp: 13 },
                        { id: 11, date: '2025/12/19', time: '17:00', location: 'Êù±‰∫¨ City Walk', type: 'ÊôØÈªû', url: '', note: '‰∏≤ËÅØÈäÄÂ∫ß„ÄÅÊñ∞Ê©ãÁ≠âÂú∞ËßÄÂÖâ„ÄÇ', weather: 'sunny', temp: 12 },
                        { id: 12, date: '2025/12/19', time: '19:00', location: 'Ê≠°Â§ßÊà∂‰πãÂ£ΩÂñúÁáí (Êó•Êú¨Ê©ã „ÅÑ„Å°„Çä)', type: 'È£üÁâ©', url: 'https://maps.app.goo.gl/wJmYfT3nL927L3gG9', note: 'ÊôöÈ§êÔºöÈªíÊØõÂíåÁâõ„Å®„ÅäÂá∫Ê±Å Êó•Êú¨Ê©ã „ÅÑ„Å°„Çä', weather: 'cloudy', temp: 10 },
                        { id: 13, date: '2025/12/19', time: '21:00', location: 'JRÂçÉËëâÁ´ô', type: 'ÊôØÈªû', url: '', note: 'ÂæûÊñ∞Êó•Êú¨Ê©ã/È¶¨Âñ∞Áî∫Êê≠JRÁ∏ΩÊ≠¶Á∑öÂø´ÈÄüÂõûÂçÉËëâ„ÄÇ', weather: 'cloudy', temp: 9 },
                        
                        { id: 14, date: '2025/12/20', time: '08:00', location: 'Ê™¢Êü•Ë°åÊùé/ÈÄÄÊàø', type: 'ÊôØÈªû', url: '', note: 'Ê™¢Êü•ÊúâÁÑ°Ë∂ÖÈáçÔºåÊèêÊó©Ê±∫ÂÆöÂä†Ë≥ºÈáçÈáè„ÄÇ', weather: 'sunny', temp: 8 },
                        { id: 15, date: '2025/12/20', time: '09:35', location: 'Richmond Hotel Narita', type: '‰ΩèÂÆø', url: '', note: 'ÂçÉËëâ->ÊàêÁî∞Á´ô (08:51) $510„ÄÇÊàêÁî∞Á´ôÂª£Â†¥ÊúâÈü≥Ê®ÇÈêò„ÄÇ', weather: 'sunny', temp: 11 },
                        { id: 16, date: '2025/12/20', time: '12:00', location: 'ÊàêÁî∞Ë°®ÂèÉÈÅì (ÂçàÈ§ê)', type: 'È£üÁâ©', url: '', note: 'Êï£Ê≠•Ëá≥Ë°®ÂèÉÈÅìÈ†Ü‰æøÂêÉÂçàÈ§ê„ÄÇ', weather: 'sunny', temp: 13 },
                        { id: 17, date: '2025/12/20', time: '14:00', location: 'ÊàêÁî∞Â±±Êñ∞ÂãùÂØ∫', type: 'ÊôØÈªû', url: '', note: '', weather: 'cloudy', temp: 12 },
                        { id: 18, date: '2025/12/20', time: '16:00', location: 'ÊàêÂãùÂØ∫ÂÖ¨Âúí', type: 'ÊôØÈªû', url: '', note: '', weather: 'cloudy', temp: 11 },
                        { id: 19, date: '2025/12/20', time: '19:00', location: 'ÁáíËÇâÊôöÈ§ê', type: 'È£üÁâ©', url: '', note: 'ÊàêÁî∞Á´ôÂë®ÈÇä„ÄÇ', weather: 'cloudy', temp: 10 },
                        
                        { id: 20, date: '2025/12/21', time: '09:30', location: '‰ΩêÂéüÁ´ô', type: 'ÊôØÈªû', url: '', note: 'ÊàêÁî∞Á´ô->‰ΩêÂéüÁ´ô $510„ÄÇÁßüÂÄüÂñÆËªä (¬•500/700)„ÄÇ', weather: 'sunny', temp: 9 },
                        { id: 21, date: '2025/12/21', time: '10:00', location: 'Â∞èÈáéÂ∑ùÈÅäËàπ', type: 'ÊôØÈªû', url: '', note: '10:00-15:30Ôºå¬•1300/‰∫∫„ÄÇ', weather: 'sunny', temp: 11 },
                        { id: 22, date: '2025/12/21', time: '11:00', location: 'Ê®ãÊ©ã/‰ºäËÉΩÂø†Êï¨ÊïÖÂ±Ö', type: 'ÊôØÈªû', url: '', note: 'Ê®ãÊ©ãÊï¥ÈªûÊµÅÊ∞¥„ÄÇÊïÖÂ±ÖÂÖçË≤ª„ÄÇ', weather: 'sunny', temp: 12 },
                        { id: 23, date: '2025/12/21', time: '12:30', location: 'Â∞èÂ†ÄÂ±ãÊú¨Â∫ó', type: 'È£üÁâ©', url: '', note: 'ÂçàÈ§êÔºöÈªëÂàáËïéÈ∫•È∫µ (¬•900)„ÄÇ', weather: 'rain', temp: 10 },
                        { id: 24, date: '2025/12/21', time: '15:30', location: 'È¶ôÂèñÁ•ûÂÆÆÁ∏ΩÁ§æ', type: 'ÊôØÈªû', url: '', note: '2600Âπ¥ÂâçËÅñÂüü„ÄÇÂª∫Ë≠∞ÂñÆÁ®ãË®àÁ®ãËªäÔºàÁ¥Ñ ¬•1,500ÔºâÊàñÂñÆËªä„ÄÇ', weather: 'cloudy', temp: 11 },
                        { id: 25, date: '2025/12/21', time: '17:00', location: 'ÈÅ≤Ê≠•Â∫µ', type: 'È£üÁâ©', url: '', note: 'ÁÉ§È∫ªÁ≥¨Á¥ÖË±ÜÊπØ„ÄÇ', weather: 'cloudy', temp: 10 },
                        { id: 26, date: '2025/12/21', time: '20:00', location: 'ÊàêÁî∞Á´ô', type: 'ÊôØÈªû', url: '', note: 'ËøîÂõûÊàêÁî∞„ÄÇ', weather: 'cloudy', temp: 8 },

                        { id: 27, date: '2025/12/22', time: '09:00', location: 'Richmond Hotel ÈÄÄÊàø', type: '‰ΩèÂÆø', url: '', note: 'È£ØÂ∫óÊó©È§ê/ÈÄÄÊàø„ÄÇ', weather: 'cloudy', temp: 7 },
                        { id: 28, date: '2025/12/22', time: '10:00', location: 'ÊàêÁî∞Ê©üÂ†¥ T1', type: 'ÊôØÈªû', url: '', note: 'Êê≠ JR ÊàêÁî∞Á∑ö/Á∏ΩÊ≠¶Á∑ö„ÄÇÂÖàÂú®Ê©üÂ†¥ÂØÑÊîæÊ®ÇÊ°ÉË°åÊùé„ÄÇ', weather: 'cloudy', temp: 9 },
                        { id: 29, date: '2025/12/22', time: '11:00', location: 'ÈÖíÈÖí‰∫ï Outlet', type: 'Ë≥ºÁâ©', url: '', note: 'ËΩâÊé•ÈßÅËªäËá≥ Outlet„ÄÇ', weather: 'sunny', temp: 11 },
                        { id: 30, date: '2025/12/22', time: '18:00', location: 'ÊàêÁî∞Ê©üÂ†¥ T1 (ÊôöÈ§ê/Ê¢≥Ê¥ó)', type: 'È£üÁâ©', url: '', note: 'Êê≠Êé•ÈßÅËªäÂõûÊ©üÂ†¥ÔºåÊôöÈ§ê/Êº±Ê¥óÂç∏Â¶ùÔºåÊõ¥ÊèõËàíÈÅ©Ë°£Èûã„ÄÇ', weather: 'cloudy', temp: 8 },
                        { id: 31, date: '2025/12/22', time: '20:00', location: 'Ê®ÇÊ°ÉÊ´ÉÊ™ØÂ†±Âà∞', type: 'ÊôØÈªû', url: '', note: 'Ëà™Áè≠MM627ÔºåÈ†êË®Ç‰ª£ËôüÔºöW9FBFU„ÄÇ', weather: 'cloudy', temp: 7 },
                        { id: 32, date: '2025/12/22', time: '22:05', location: 'Ê°ÉÂúíÁ¨¨‰∏ÄËà™Âªà', type: 'ÊôØÈªû', url: '', note: 'È†êË®à 01:25 ÊäµÈÅî TPE', weather: 'cloudy', temp: 6 },
                    ],
                    expenses: [
                        { id: 1, date: '2025/12/18', title: 'Suica ÂÑ≤ÂÄº', amount: 5000, currency: 'JPY', category: '‰∫§ÈÄö', payer: 'Catty' },
                        { id: 2, date: '2025/12/18', title: 'ÂÆ¢Â§öÁæéÊó©È§ê', amount: 1200, currency: 'JPY', category: 'È£üÁâ©', payer: 'Tony' },
                    ],
                    todoList: [
                        { text: 'Ë≥ºË≤∑ÊóÖÈÅä‰øùÈö™', status: { Catty: false, Tony: false, Tina: false, Anita: false } },
                        { text: 'ÈñãÈÄöÊº´ÈÅä/Ë≤∑Á∂≤Âç°', status: { Catty: false, Tony: false, Tina: false, Anita: false } },
                        { text: 'Â°´ÂØ´ Visit Japan Web', status: { Catty: false, Tony: false, Tina: false, Anita: false } },
                        { text: 'Êù±Ëñ∞ÈÖíÈÄ†È†êÁ¥Ñ', status: { Catty: false, Tony: false, Tina: false, Anita: false } },
                    ],
                    shoppingList: [
                        { text: 'UQ ÁôºÁÜ±Ë°£', done: false, price: 1290, owner: 'Catty', url: '', quantity: 1 }, 
                        { text: 'ÂêàÂà©‰ªñÂëΩ', done: false, price: 5500, owner: 'Tony', url: '', quantity: 1 },
                        { text: 'ÂîêÂêâËªªÂæ∑Èõ∂È£ü', done: false, price: 3000, owner: 'Tina', url: '', quantity: 2 },
                    ],
                    exchangeRate: 0.218
                });
                
                // Form/Input States
                const newTodoText = ref('');
                const newShoppingItem = ref({ text: '', price: '', owner: members[0], url: '', quantity: 1 });
                const modalForm = ref({ id: null, time: '', location: '', type: 'ÊôØÈªû', url: '', note: '', weather: 'sunny', temp: 10 }); 
                const expenseForm = ref({ date: dates[0].date, amount: '', title: '', currency: 'JPY', payer: members[0] });
                
                const myLocation = ref(null);
                const sortableList = ref(null);

                // --- Firebase Handlers ---

                const startRealtimeListener = () => {
                    if (!tripDocRef) return;

                    onSnapshot(tripDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            // Apply cloud data to local state
                            // Use JSON.parse(JSON.stringify()) to ensure proper reactivity update for nested data
                            itinerary.value = JSON.parse(JSON.stringify(data.itinerary || getDefaultData().itinerary));
                            expenses.value = JSON.parse(JSON.stringify(data.expenses || getDefaultData().expenses));
                            todoList.value = JSON.parse(JSON.stringify(data.todoList || getDefaultData().todoList));
                            shoppingList.value = JSON.parse(JSON.stringify(data.shoppingList || getDefaultData().shoppingList));
                            exchangeRate.value = data.exchangeRate || 0.218;
                            console.log("Realtime data updated from Firestore.");
                        } else {
                            console.log("No data found, initializing with default data.");
                            // If document doesn't exist, create it with default data
                            runTransaction(db, async (transaction) => {
                                const freshDoc = await transaction.get(tripDocRef);
                                if (!freshDoc.exists()) {
                                    const initialData = getDefaultData();
                                    transaction.set(tripDocRef, { ...initialData, createdAt: serverTimestamp() });
                                    // Set initial local state from default
                                    itinerary.value = initialData.itinerary;
                                    expenses.value = initialData.expenses;
                                    todoList.value = initialData.todoList;
                                    shoppingList.value = initialData.shoppingList;
                                    exchangeRate.value = initialData.exchangeRate;
                                }
                            });
                        }
                        isDataReady.value = true;
                    }, (error) => {
                        console.error("Error listening to Firestore:", error);
                        isDataReady.value = true; 
                    });
                };

                const saveData = async () => {
                    if (!tripDocRef || !isAuthReady.value) {
                        console.warn("Attempted to save data before Firebase was ready.");
                        return;
                    }
                    try {
                        const dataToSave = {
                            itinerary: itinerary.value,
                            expenses: expenses.value,
                            todoList: todoList.value,
                            shoppingList: shoppingList.value,
                            exchangeRate: exchangeRate.value,
                            updatedAt: serverTimestamp()
                        };
                        await setDoc(tripDocRef, dataToSave);
                    } catch (error) {
                        console.error("Error saving data to Firestore:", error);
                    }
                };
                
                // --- Utility Functions ---

                const fetchWeatherForLocation = async (locationName) => {
                    // Mock Weather Data
                    const cityNameKey = locationName.split(' ')[0];
                    const cityConfig = CITY_MAP[cityNameKey] || CITY_MAP['ÂçÉËëâ'];
                    
                    if (weatherCache[cityNameKey]) return weatherCache[cityNameKey];
                    
                    const tempRange = { min: cityConfig.min, max: cityConfig.max };
                    const conditions = ['sunny', 'cloudy', 'rain'];
                    
                    const result = {
                        temp: Math.floor(Math.random() * (tempRange.max - tempRange.min + 1)) + tempRange.min, 
                        condition: conditions[Math.floor(Math.random() * conditions.length)]
                    };
                    
                    weatherCache[cityNameKey] = result;
                    return result;
                };

                // --- Computed Properties ---
                const currentDateDisplay = computed(() => dates[selectedDateIndex.value].date);
                const currentDayItinerary = computed(() => {
                    const d = dates[selectedDateIndex.value].date;
                    return itinerary.value.filter(i => i.date === d).sort((a,b) => a.time.localeCompare(b.time));
                });

                const filteredShoppingList = computed(() => {
                    if (!shoppingFilterOwner.value) {
                        return shoppingList.value;
                    }
                    return shoppingList.value.filter(item => item.owner === shoppingFilterOwner.value);
                });
                
                const currentFilteredShoppingTotalJPY = computed(() => {
                    return filteredShoppingList.value.reduce((sum, item) => {
                        const price = parseFloat(item.price) || 0;
                        const quantity = parseInt(item.quantity) || 0;
                        return sum + (price * quantity);
                    }, 0);
                });

                const currentFilteredShoppingTotalTWD = computed(() => {
                    return Math.round(currentFilteredShoppingTotalJPY.value * exchangeRate.value).toLocaleString();
                });
                
                const currentMapUrl = computed(() => {
                    const locations = currentDayItinerary.value.map(item => item.location).join('+and+');
                    if (locations.length > 0) {
                        return `https://maps.google.com/maps?q=${encodeURIComponent(locations)}&t=&z=11&ie=UTF8&iwloc=&output=embed`;
                    }
                    return `https://www.google.com/maps/d/embed?mid=1P71Wk_k8Y7a2tX9q0s-x6w?hl=zh-TW`;
                });

                const expenseGroups = computed(() => {
                    const groups = {};
                    expenses.value.forEach(exp => {
                        if (!groups[exp.date]) groups[exp.date] = { items: [], totalTWD: 0 };
                        groups[exp.date].items.push(exp);
                        const amountInTWD = exp.currency === 'JPY' ? (exp.amount * exchangeRate.value) : parseInt(exp.amount);
                        groups[exp.date].totalTWD += amountInTWD;
                    });
                    return groups;
                });
                const totalExpenseTWD = computed(() => {
                    return expenses.value.reduce((sum, item) => {
                        return sum + (item.currency === 'JPY' ? (item.amount * exchangeRate.value) : parseInt(item.amount));
                    }, 0).toFixed(0);
                });

                const getMemberTotal = (member) => {
                    return expenses.value
                        .filter(e => e.payer === member)
                        .reduce((sum, item) => {
                            return sum + (item.currency === 'JPY' ? (item.amount * exchangeRate.value) : parseInt(item.amount));
                        }, 0).toFixed(0);
                };

                // --- Action Methods ---

                const openGoogleMapsRoute = () => {
                    const destination = modalForm.value.location;
                    if (!destination) {
                        alert("Ë´ãÂÖàËº∏ÂÖ•Âú∞ÈªûÂêçÁ®±‰ΩúÁÇ∫ÁµÇÈªû");
                        return;
                    }

                    const url = `https://www.google.com/maps/dir/?api=1&origin=Current+Location&destination=${encodeURIComponent(destination)}&travelmode=transit`;
                    window.open(url, '_blank');
                };

                const selectDate = (idx) => {
                    selectedTab.value = 'schedule';
                    selectedDateIndex.value = idx;
                    currentMapLocation.value = '';
                    nextTick(() => initSortable());
                };

                const openAddModal = () => {
                    if (selectedTab.value === 'schedule') {
                        modalForm.value = { id: null, time: '10:00', location: '', type: 'ÊôØÈªû', url: '', note: '', weather: 'sunny', temp: 10 };
                    } else if (selectedTab.value === 'wallet') {
                        expenseForm.value = { date: dates[selectedDateIndex.value].date, amount: '', title: '', currency: 'JPY', payer: members[0] };
                    }
                    showEditModal.value = true;
                };

                const closeEditModal = () => showEditModal.value = false;
                const editItem = (item) => {
                    modalForm.value = JSON.parse(JSON.stringify(item));
                    if (typeof modalForm.value.weather === 'undefined') modalForm.value.weather = 'sunny';
                    if (typeof modalForm.value.temp === 'undefined') modalForm.value.temp = 10;
                    showEditModal.value = true;
                };
                
                const saveItineraryItem = async () => {
                    const weatherData = await fetchWeatherForLocation(modalForm.value.location);
                    
                    const itemToSave = { 
                        ...modalForm.value, 
                        date: dates[selectedDateIndex.value].date,
                        weather: weatherData.condition,
                        temp: weatherData.temp,
                        transport: { method: '', cost: '', duration: '' } 
                    };

                    if (itemToSave.id) {
                        const idx = itinerary.value.findIndex(i => i.id === itemToSave.id);
                        if (idx !== -1) itinerary.value[idx] = itemToSave;
                    } else {
                        itemToSave.id = Date.now();
                        itinerary.value.push(itemToSave);
                    }
                    await saveData();
                    closeEditModal();
                };

                const deleteItem = (id) => {
                    if(confirm('Âà™Èô§Ê≠§Ë°åÁ®ãÔºü')) {
                        itinerary.value = itinerary.value.filter(i => i.id !== id);
                        saveData();
                    }
                };
                const updateMapLocation = (loc) => currentMapLocation.value = loc;
                const saveExpense = () => {
                    if(!expenseForm.value.amount || !expenseForm.value.title) return;
                    expenses.value.unshift({ id: Date.now(), ...expenseForm.value });
                    saveData();
                    closeEditModal();
                };
                const deleteExpense = (id) => {
                    if(confirm('Âà™Èô§Ê≠§Á¥ÄÈåÑÔºü')) expenses.value = expenses.value.filter(e => e.id !== id);
                    saveData();
                };
                
                const addTodo = () => {
                    if(newTodoText.value) {
                        todoList.value.push({ text: newTodoText.value, status: createStatus() });
                        newTodoText.value = '';
                        saveData();
                    }
                };
                const removeTodo = (i) => { todoList.value.splice(i, 1); saveData(); };
                
                const addShoppingItem = () => {
                    if(newShoppingItem.value.text) {
                        newShoppingItem.value.quantity = parseInt(newShoppingItem.value.quantity) || 1;
                        shoppingList.value.push({ ...newShoppingItem.value, done: false });
                        newShoppingItem.value = { text: '', price: '', owner: members[0], url: '', quantity: 1 }; // Reset
                        saveData();
                    }
                };
                const removeShoppingItem = (i) => { 
                    const itemToRemove = filteredShoppingList.value[i];
                    const globalIndex = shoppingList.value.findIndex(item => item.text === itemToRemove.text && item.owner === itemToRemove.owner && item.price === itemToRemove.price && item.quantity === itemToRemove.quantity);
                    if (globalIndex !== -1) {
                         shoppingList.value.splice(globalIndex, 1);
                         saveData();
                    }
                };

                // --- Utility Getters & Display ---

                const getWeatherIcon = (w) => {
                    const map = { 
                        sunny: 'fa-solid fa-sun text-yellow-500', 
                        cloudy: 'fa-solid fa-cloud text-slate-400', 
                        rain: 'fa-solid fa-cloud-showers-heavy text-primaryDark' 
                    };
                    return map[w] || map.sunny;
                };
                
                const getTypeIcon = (t) => {
                    const map = { 'È£üÁâ©': 'üçú', 'Ë≥ºÁâ©': 'üõçÔ∏è', 'ÊôØÈªû': 'üì∑', '‰ΩèÂÆø': 'üè®' };
                    return map[t] || 'üìç';
                };
                const getTypeClass = (t) => {
                    const map = { 'È£üÁâ©': 'type-food', 'Ë≥ºÁâ©': 'type-shop', 'ÊôØÈªû': 'type-spot', '‰ΩèÂÆø': 'type-stay' };
                    return map[t] || 'bg-slate-100 text-slate-500';
                };
                const locateMe = () => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((pos) => {
                            currentMapLocation.value = `${pos.coords.latitude},${pos.coords.longitude}`;
                            alert(`Â∑≤ÂÆö‰Ωç`);
                        });
                    }
                };

                // --- Initialization ---
                const initSortable = () => {
                    if (sortableList.value) new Sortable(sortableList.value, { animation: 150, handle: '.cursor-grab', ghostClass: 'sortable-ghost' });
                };

                onMounted(async () => { 
                    const firebaseData = await initializeFirebase();
                    userId.value = firebaseData.userId;
                    isAuthReady.value = true;
                    
                    // Start real-time listener only after successful auth
                    startRealtimeListener(); 
                    
                    nextTick(() => initSortable()); 
                });
                watch(selectedTab, () => { if(selectedTab.value === 'schedule') nextTick(() => initSortable()); });

                return {
                    members, selectedTab, selectedDateIndex, dates, itinerary, expenses, todoList, shoppingList,
                    newTodoText, newShoppingItem, modalForm, expenseForm, showShoppingModal, showEditModal, exchangeRate,
                    currentDateDisplay, currentDayItinerary, expenseGroups, totalExpenseTWD, currentMapLocation, currentMapUrl,
                    shoppingFilterOwner, filteredShoppingList, currentFilteredShoppingTotalJPY, currentFilteredShoppingTotalTWD,
                    selectDate, openAddModal, closeEditModal, editItem, saveItineraryItem, deleteItem,
                    saveExpense, deleteExpense, addTodo, removeTodo, addShoppingItem, removeShoppingItem,
                    getWeatherIcon, getTypeIcon, getTypeClass, locateMe, updateMapLocation, 
                    openGoogleMapsRoute, getMemberTotal,
                    // Firebase/App data for display
                    isAuthReady, isDataReady, userId, appId 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
