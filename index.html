<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂçÉËëâ‰πãÊóÖ Chiba Pro V21 (Ëé´Ëò≠Ëø™Á¥îÊ∑®Áâà)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Noto Sans TC) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F8FAFC; 
            -webkit-tap-highlight-color: transparent;
            color: #475569;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .soft-shadow { box-shadow: 0 4px 20px rgba(148, 163, 184, 0.15); }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-top: 1px solid #E2E8F0; }
        .map-container iframe { width: 100%; height: 100%; border: 0; }
        
        /* --- STRICT MORANDI PALETTE (No Purple) --- */
        /* Logic: Background L~93%, S~15% | Text L~40%, S~20% */

        /* Type Badges */
        .type-food { background-color: #F4EEE3; color: #8C755E; } /* Dusty Brown */
        .type-shop { background-color: #E3F0F4; color: #5E7C8C; } /* Dusty Sky */
        .type-spot { background-color: #E3F4F4; color: #5E8C8C; } /* Dusty Teal */
        .type-stay { background-color: #E6F4E3; color: #668C5E; } /* Dusty Green */

        /* UI Accents */
        .primary { background-color: #93B5C6; } /* Dusty Blue */
        .primaryDark { color: #5B7A8D; } /* Darker Dusty Blue */
        
        /* Member Badges */
        .member-badge-Catty { background-color: #F4E3E3; color: #8C5E5E; } /* Dusty Rose */
        .member-badge-Tony { background-color: #E3E9F4; color: #5E6C8C; } /* Foggy Blue */
        .member-badge-Tina { background-color: #F4F1E3; color: #8C865E; } /* Linen Beige */
        .member-badge-Anita { background-color: #F4E8E3; color: #8C665E; } /* Clay Apricot */
        
        /* Payment Badges - STRICTLY NO PURPLE */
        .pay-cash { background-color: #F0F0F0; color: #707070; } /* Warm Gray */
        .pay-card { background-color: #DDE9F2; color: #5A6E85; } /* Dusty Slate Blue (Replaces Purple) */
        .pay-epay { background-color: #E3F4E6; color: #5E8C66; } /* Dusty Sage */

        /* Small input for quantity */
        .qty-input {
            width: 3rem;
            text-align: center;
            padding: 0.1rem;
            border-bottom: 1px solid #CBD5E1;
            background: transparent;
        }
        
        /* Transitions */
        .list-move,
        .list-enter-active,
        .list-leave-active {
            transition: all 0.5s ease;
        }
        .list-enter-from,
        .list-leave-to {
            opacity: 0;
            transform: translateX(30px);
        }
        .list-leave-active {
            position: absolute;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#93B5C6', 
                        primaryDark: '#5B7A8D', 
                        textMain: '#334155'
                    }
                }
            }
        }
    </script>
</head>
<body class="text-textMain h-screen overflow-hidden flex flex-col bg-slate-50">

    <div id="app" class="flex flex-col h-full relative max-w-md mx-auto w-full bg-white shadow-2xl overflow-hidden">
        
        <!-- Loading Screen -->
        <div v-if="!isDataReady" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-[99] flex flex-col items-center justify-center">
            <i class="fa-solid fa-spinner fa-spin-pulse text-primaryDark text-4xl mb-4"></i>
            <p class="text-sm text-slate-600">Ê≠£Âú®ÂêåÊ≠•Èõ≤Á´ØË≥áÊñô...</p>
        </div>

        <!-- Header -->
        <header class="bg-white pt-10 pb-2 px-5 z-20 shrink-0 shadow-sm">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-2xl font-bold tracking-tight text-slate-800">Chiba Trip <span class="text-primaryDark">v21</span></h1>
                    <p class="text-xs text-slate-400 mt-0.5" v-if="selectedTab !== 'todo'">{{ currentDateDisplay }}</p>
                </div>
            </div>
            
            <!-- Collaborative Info -->
            <div class="text-[10px] text-slate-400 mb-2 flex justify-between items-center bg-slate-100/50 p-1.5 rounded-lg border border-slate-100">
                <span class="font-mono text-primaryDark">App: {{ appId.substring(0, 8) }}...</span>
                <span class="font-mono">User: {{ userId.substring(0, 8) }}...</span>
            </div>

            <!-- Tabs -->
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 pb-2 snap-x items-center">
                <div @click="selectedTab = 'todo'" 
                     class="snap-start shrink-0 flex flex-col items-center justify-center px-4 h-16 rounded-2xl transition-all border-2 cursor-pointer"
                     :class="selectedTab === 'todo' ? 'bg-slate-600 border-slate-600 text-white shadow-lg' : 'bg-white border-slate-200 text-slate-400'">
                    <span class="text-xs font-medium">Ë°åÂâç</span>
                    <i class="fa-solid fa-clipboard-check mt-1"></i>
                </div>
                <div v-for="(day, index) in dates" :key="index" @click="selectDate(index)"
                    class="snap-start shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-2xl transition-all border-2 cursor-pointer"
                    :class="(selectedTab === 'schedule' && selectedDateIndex === index) ? 'bg-primary border-primary text-white shadow-lg transform scale-105' : 'bg-white border-slate-200 text-slate-400'">
                    <span class="text-[10px] uppercase font-bold tracking-wider">{{ day.weekday }}</span>
                    <span class="text-lg font-bold">{{ day.date.split('/')[2] }}</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto hide-scrollbar bg-slate-50 relative pb-28">

            <!-- 1. Ë°åÂâç TODO -->
            <div v-if="selectedTab === 'todo'" class="p-5 space-y-4">
                <div class="bg-white rounded-3xl p-6 soft-shadow">
                    <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center">
                        <i class="fa-solid fa-list-check text-primaryDark mr-2"></i> Ë°åÂâçÊ∫ñÂÇô
                    </h2>
                    <div class="space-y-6">
                        <div v-for="(item, idx) in todoList" :key="idx" class="group border-b border-slate-50 pb-4 last:border-0">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-slate-700 font-bold">{{ item.text }}</span>
                                <button @click="removeTodo(idx)" class="text-slate-200 hover:text-red-400 transition"><i class="fa-solid fa-times"></i></button>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <label v-for="member in members" :key="member" class="flex items-center space-x-2 cursor-pointer bg-slate-50 p-2 rounded-lg hover:bg-slate-100">
                                    <input type="checkbox" v-model="item.status[member]" @change="saveData" class="w-4 h-4 rounded text-slate-500 border-slate-300 accent-slate-500">
                                    <span class="text-xs text-slate-500" :class="{'line-through opacity-50': item.status[member]}">{{ member }}</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex items-center mt-2 bg-slate-50 rounded-xl px-3 py-2">
                            <i class="fa-solid fa-plus text-slate-400 mr-2"></i>
                            <input v-model="newTodoText" @keyup.enter="addTodo" placeholder="Êñ∞Â¢ûÂæÖËæ¶‰∫ãÈ†Ö..." class="flex-1 bg-transparent outline-none text-sm text-slate-600">
                            <button @click="addTodo" class="text-primaryDark font-bold text-sm">Êñ∞Â¢û</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Ë°åÁ®ãË°® -->
            <div v-if="selectedTab === 'schedule'" class="p-5">
                <div v-if="currentDayItinerary.length === 0" class="text-center py-12 text-slate-400">
                    <div class="text-4xl mb-3">üìÖ</div>
                    <p>Êú¨Êó•ÁÑ°Ë°åÁ®ãÔºåË´ãÈªûÊìä + Êñ∞Â¢û</p>
                </div>

                <div class="space-y-0 relative pb-10">
                    <div class="absolute left-[19px] top-4 bottom-0 w-0.5 bg-slate-200 -z-10"></div>

                    <transition-group name="list">
                        <div v-for="(item, index) in currentDayItinerary" :key="item.id" class="relative pl-10 mb-6 group">
                            <!-- Time Dot -->
                            <div class="absolute left-0 top-5 w-10 flex justify-center z-10">
                                <div class="w-3 h-3 rounded-full border-2 border-white shadow-sm bg-primaryDark"></div>
                            </div>

                            <!-- Card -->
                            <div class="bg-white rounded-2xl p-4 soft-shadow border border-slate-50 hover:border-primary transition relative overflow-hidden">
                                <div class="flex justify-between items-start mb-2 pr-2">
                                    <div class="flex items-center space-x-2">
                                        <span class="font-bold text-primaryDark font-mono text-sm bg-primary/20 px-2 py-0.5 rounded-md">{{ item.time }}</span>
                                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center" :class="getTypeClass(item.type)">
                                            {{ getTypeIcon(item.type) }} {{ item.type }}
                                        </span>
                                    </div>
                                </div>
                                
                                <h3 class="text-lg font-bold text-slate-800 mb-1 leading-snug flex items-center">
                                    <a v-if="item.url" :href="item.url" target="_blank" class="hover:text-primaryDark hover:underline flex items-center">
                                        {{ item.location }} <i class="fa-solid fa-arrow-up-right-from-square text-[10px] ml-1.5 opacity-50"></i>
                                    </a>
                                    <span v-else>{{ item.location }}</span>
                                </h3>
                                
                                <p v-if="item.note" class="text-sm text-slate-500 leading-relaxed whitespace-pre-line mb-2">{{ item.note }}</p>

                                <!-- üöÄ Á´ãÂç≥Â∞éËà™ÊåâÈàï -->
                                <button @click.stop="startNavigation(item)" class="mt-2 text-xs bg-[#F0F4F7] text-[#5B7A8D] px-3 py-2 rounded-lg flex items-center font-bold hover:bg-[#E0E7EB] transition w-full justify-center">
                                    <i class="fa-solid fa-location-arrow mr-2"></i> Á´ãÂç≥Â∞éËà™
                                </button>
                                
                                <!-- Actions -->
                                <div class="flex justify-end space-x-3 mt-3 border-t border-slate-50 pt-2">
                                    <button @click.stop="editItem(item)" class="text-xs text-slate-400 hover:text-primaryDark font-medium"><i class="fa-regular fa-pen-to-square mr-1"></i>Á∑®ËºØ</button>
                                    <button @click.stop="deleteItem(item.id)" class="text-xs text-slate-400 hover:text-red-400 font-medium"><i class="fa-regular fa-trash-can mr-1"></i>Âà™Èô§</button>
                                </div>
                            </div>
                        </div>
                    </transition-group>
                </div>
            </div>

            <!-- 3. Âú∞Âúñ -->
            <div v-if="selectedTab === 'map'" class="h-full flex flex-col relative">
                <div class="h-3/5 w-full bg-slate-200 relative map-container">
                    <iframe :src="currentMapUrl" loading="lazy" allowfullscreen></iframe>
                    <div class="absolute bottom-4 right-4">
                         <button @click="locateMe" class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-slate-600 hover:text-primaryDark">
                            <i class="fa-solid fa-crosshairs"></i>
                        </button>
                    </div>
                </div>
                <div class="flex-1 bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] overflow-hidden flex flex-col -mt-5 relative z-10">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white">
                        <h3 class="font-bold text-slate-700">‰ªäÊó•Ë∑ØÁ∑öËàáÈáòÈÅ∏Èªû</h3>
                        <a href="https://maps.app.goo.gl/xMjXvbGtCYEqxWPKA" target="_blank" class="text-xs text-white bg-primaryDark px-3 py-1.5 rounded-lg hover:bg-primary transition shadow-lg shadow-blue-200/50 font-bold">
                            <i class="fa-solid fa-map-location-dot mr-1"></i>ÈñãÂïüÊ∏ÖÂñÆ
                        </a>
                    </div>
                    
                    <div class="overflow-y-auto p-4 space-y-2 pb-20">
                        <div v-if="currentDayItinerary.length === 0" class="text-center text-slate-400 text-sm py-4">Êú¨Êó•ÁÑ°Ë°åÁ®ãÔºåÂú∞ÂúñÂÉÖÈ°ØÁ§∫È†êË®≠ÂçÄÂüü„ÄÇ</div>
                        <div v-for="(item, idx) in currentDayItinerary" :key="idx" 
                             @click="updateMapLocation(item.location)"
                             class="flex items-center p-3 rounded-xl border border-slate-100 hover:border-primary/50 hover:bg-slate-50 transition cursor-pointer group"
                             :class="{'bg-primary/20 border-primary': currentMapLocation === item.location}">
                            <span class="w-6 h-6 rounded-full bg-slate-200 text-slate-500 text-xs flex items-center justify-center mr-3 font-mono shrink-0 group-hover:bg-primaryDark group-hover:text-white">{{ idx + 1 }}</span>
                            <div class="flex-1">
                                <div class="font-medium text-slate-700">{{ item.location }}</div>
                                <div class="text-[10px] text-slate-400 flex items-center gap-2">
                                    <span :class="getTypeClass(item.type)" class="px-1 rounded-full text-[10px] font-bold">{{ item.type }}</span>
                                </div>
                            </div>
                            <a :href="item.url || 'https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(item.location)" target="_blank" class="text-primaryDark hover:text-primary p-2 rounded-full hover:bg-slate-100">
                                <i class="fa-solid fa-location-arrow"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Ë≥ºÁâ©Ê∏ÖÂñÆ -->
            <div v-if="selectedTab === 'shopping'" class="flex flex-col h-full relative">
                <!-- 1. Filter Tabs (Sticky Top) -->
                <div class="bg-white p-2 soft-shadow sticky top-0 z-30 shrink-0 border-b border-slate-100">
                    <div class="flex overflow-x-auto hide-scrollbar space-x-2">
                        <button @click="shoppingFilterOwner = ''"
                                :class="shoppingFilterOwner === '' ? 'bg-primaryDark text-white' : 'bg-slate-100 text-slate-500 hover:bg-primary/20'"
                                class="shrink-0 text-xs font-bold px-3 py-1.5 rounded-xl transition">ÂÖ®ÈÉ®</button>
                        <button v-for="m in members" :key="m"
                                @click="shoppingFilterOwner = m"
                                :class="shoppingFilterOwner === m ? 'bg-primaryDark text-white' : 'bg-slate-100 text-slate-500 hover:bg-primary/20'"
                                class="shrink-0 text-xs font-bold px-3 py-1.5 rounded-xl transition">
                                {{ m }}
                        </button>
                    </div>
                </div>

                <!-- 2. Scrollable Area (Form + List) -->
                <div class="flex-1 overflow-y-auto hide-scrollbar p-5 pb-32">
                    
                    <!-- Add/Edit Form (Normal Flow) -->
                    <div class="bg-blue-50 p-3 rounded-2xl border border-blue-100 space-y-2 mb-4 shadow-sm">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-primaryDark">{{ editingShoppingId ? 'Á∑®ËºØÈ†ÖÁõÆ' : 'Êñ∞Â¢ûÈ†ÖÁõÆ' }}</span>
                            <button v-if="editingShoppingId" @click="cancelShoppingEdit" class="text-xs text-slate-400 hover:text-slate-600">ÂèñÊ∂à</button>
                        </div>
                        <!-- Á¨¨‰∏ÄÊéíÔºöÂêçÁ®± -->
                        <div>
                            <input v-model="newShoppingItem.text" placeholder="ÂìÅÈ†ÖÂêçÁ®±" class="w-full bg-white rounded-lg px-3 py-2 outline-none text-sm">
                        </div>
                        <!-- Á¨¨‰∫åÊéíÔºö‰∫∫Âêç / ÂñÆÂÉπ / Êï∏Èáè -->
                        <div class="flex space-x-2">
                            <select v-model="newShoppingItem.owner" class="bg-white rounded-lg px-2 py-2 outline-none text-xs flex-1 text-slate-600 min-w-0">
                                <option v-for="m in members" :value="m">{{ m }}</option>
                            </select>
                            <input v-model.number="newShoppingItem.price" type="number" placeholder="¬• ÂñÆÂÉπ" class="bg-white rounded-lg px-2 py-2 outline-none text-sm flex-1 min-w-0">
                            <input v-model.number="newShoppingItem.quantity" type="number" placeholder="Êï∏Èáè" class="bg-white rounded-lg px-2 py-2 outline-none text-sm w-16 text-center">
                        </div>
                        <!-- Á¨¨‰∏âÊéíÔºöÈÄ£Áµê -->
                        <div>
                            <input v-model="newShoppingItem.url" placeholder="ÂïÜÂìÅÈÄ£Áµê (URL)" class="w-full bg-white rounded-lg px-3 py-2 outline-none text-xs">
                        </div>
                        <div class="flex justify-end">
                            <button @click="addOrUpdateShoppingItem" class="bg-primaryDark text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg shadow-primary/50 w-full">
                                {{ editingShoppingId ? 'Êõ¥Êñ∞' : 'Êñ∞Â¢û' }}
                            </button>
                        </div>
                    </div>

                    <!-- List Items -->
                    <div class="space-y-3">
                        <transition-group name="list">
                            <div v-for="(item, idx) in filteredShoppingList" :key="item.id || idx" class="flex flex-col p-3 bg-white rounded-2xl soft-shadow border border-slate-50 relative overflow-hidden">
                                <div class="flex items-start justify-between mb-1 relative z-10">
                                    <div class="flex items-center flex-1">
                                        <input type="checkbox" v-model="item.done" @change="saveData" class="w-5 h-5 text-blue-500 rounded border-slate-300 focus:ring-blue-500 cursor-pointer">
                                        <div class="ml-3 flex-1">
                                            <div class="flex items-center space-x-2">
                                                <span class="font-medium text-slate-700" :class="{'line-through text-slate-400': item.done}">{{ item.text }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button @click="editShoppingItem(item)" class="text-slate-400 hover:text-primaryDark"><i class="fa-solid fa-pen"></i></button>
                                        <button @click="removeShoppingItem(item)" class="text-slate-300 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>
                                    </div>
                                </div>
                                <!-- Layout: Owner | Price | Qty -->
                                <div class="flex items-center ml-8 text-xs text-slate-500 relative z-10 gap-3 mt-1">
                                    <span v-if="item.owner" class="text-[10px] px-1.5 py-0.5 rounded font-bold" :class="'member-badge-'+item.owner">{{ item.owner }}</span>
                                    
                                    <span class="flex items-center">
                                        ¬• {{ (item.price || 0).toLocaleString() }}
                                    </span>
                                    
                                    <span class="flex items-center">
                                        x <input type="number" v-model.number="item.quantity" @input="saveData" min="1" class="w-8 text-center bg-transparent border-b border-slate-200 outline-none mx-1 focus:border-primaryDark">
                                    </span>

                                    <a v-if="item.url" :href="item.url" target="_blank" class="text-blue-400 hover:underline flex items-center ml-auto">
                                        <i class="fa-solid fa-link mr-1"></i> ÂïÜÂìÅÈÄ£Áµê
                                    </a>
                                </div>
                            </div>
                        </transition-group>
                    </div>
                </div>
                
                <!-- 3. Fixed Total (Pinned to Bottom above Nav) -->
                <div class="absolute bottom-0 left-0 right-0 bg-white/95 border-t border-slate-200 p-4 z-40 backdrop-blur-md shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
                    <div class="flex justify-between items-center font-bold text-sm text-slate-700">
                        <span>Á∏ΩË®à ({{ shoppingFilterOwner || 'ÂÖ®ÈÉ®' }})</span>
                        <div class="text-right">
                            <span class="block text-primaryDark">¬• {{ currentFilteredShoppingTotalJPY.toLocaleString() }}</span>
                            <span class="block text-xs text-slate-400">‚âà NT$ {{ currentFilteredShoppingTotalTWD }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. Èå¢ÂåÖ -->
            <div v-if="selectedTab === 'wallet'" class="p-5 pb-32 space-y-6">
                <!-- Á∏ΩË¶Ω -->
                <div class="bg-gradient-to-br from-primaryDark to-slate-600 rounded-3xl p-5 text-white shadow-lg shadow-primary/50 relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <h3 class="font-bold text-lg">ÊóÖË≤ªÁ∏ΩË¶Ω (NT$)</h3>
                        <div class="text-[10px] bg-white/20 px-2 py-1 rounded backdrop-blur-sm flex items-center">
                            È†ê‰º∞ÂåØÁéá: {{ exchangeRate.toFixed(4) }}
                            <span class="ml-2 text-[8px] opacity-75">Êõ¥Êñ∞Êñº: {{ exchangeRateDate || '‰ªäÊó•' }}</span>
                        </div>
                    </div>
                    <div class="flex items-baseline space-x-1 relative z-10">
                        <span class="text-3xl font-bold tracking-tight">${{ filteredExpenseTotalTWD.toLocaleString() }}</span>
                    </div>
                    
                    <!-- NEW: Date Filter -->
                    <div class="mt-4 flex gap-2 overflow-x-auto hide-scrollbar relative z-10">
                         <button @click="expenseFilterDate = ''" 
                                 :class="expenseFilterDate === '' ? 'bg-white text-primaryDark' : 'bg-white/20 text-white hover:bg-white/30'"
                                 class="px-3 py-1 rounded-full text-xs font-bold transition shrink-0">
                             ÂÖ®ÈÉ®
                         </button>
                         <button v-for="d in dates" :key="d.date" @click="expenseFilterDate = d.date"
                                 :class="expenseFilterDate === d.date ? 'bg-white text-primaryDark' : 'bg-white/20 text-white hover:bg-white/30'"
                                 class="px-3 py-1 rounded-full text-xs font-bold transition shrink-0">
                             {{ d.date.split('/')[2] }}Êó•
                         </button>
                    </div>
                </div>

                <!-- ÂàÜ‰∫∫Áµ±Ë®à (Shows filtered stats if filter active, else all) -->
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="m in members" :key="m" class="bg-white p-3 rounded-2xl soft-shadow border border-slate-50">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-bold px-2 py-0.5 rounded-md" :class="'member-badge-'+m">{{ m }}</span>
                            <span class="text-[10px] text-slate-400">Â∑≤ÊîØ‰ªò</span>
                        </div>
                        <div class="text-lg font-bold text-slate-700">
                            NT${{ getMemberTotal(m).toLocaleString() }}
                        </div>
                    </div>
                </div>

                <!-- ÊØèÊó•ÊòéÁ¥∞ (Editable) -->
                <div class="space-y-4">
                    <div v-for="(group, dateStr) in filteredExpenseGroups" :key="dateStr" class="bg-white rounded-2xl soft-shadow overflow-hidden">
                        <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 flex justify-between items-center">
                            <span class="font-bold text-slate-600 text-sm">{{ dateStr }}</span>
                            <span class="text-xs font-mono font-bold text-slate-400">Â∞èË®à: NT$ {{ Math.round(group.totalTWD).toLocaleString() }}</span>
                        </div>
                        <div class="divide-y divide-slate-50">
                            <div v-for="(exp, idx) in group.items" :key="idx" @click="editExpense(exp)" class="p-4 hover:bg-slate-50 transition group/item cursor-pointer relative">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="text-slate-700 font-medium text-sm">{{ exp.title }}</div>
                                        <div class="flex items-center space-x-2 mt-1">
                                            <span class="text-[10px] px-1.5 py-0.5 rounded font-bold" :class="'member-badge-'+exp.payer">{{ exp.payer }}</span>
                                            <!-- Payment Method Badge -->
                                            <span v-if="exp.paymentMethod" class="text-[10px] px-1.5 py-0.5 rounded" :class="getPaymentBadgeClass(exp.paymentMethod)">
                                                {{ exp.paymentMethod }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="text-right mr-3">
                                            <div class="font-mono font-bold text-slate-700">
                                                {{ exp.currency === 'JPY' ? '¬•' : 'NT$' }}{{ parseInt(exp.amount).toLocaleString() }}
                                            </div>
                                            <div v-if="exp.currency === 'JPY'" class="text-[10px] text-slate-400">
                                                ‚âà NT${{ Math.round(exp.amount * exchangeRate).toLocaleString() }}
                                                <span v-if="exp.paymentMethod === '‰ø°Áî®Âç°'" class="text-[8px] text-red-400 block">(Âê´ÊâãÁ∫åË≤ª)</span>
                                            </div>
                                        </div>
                                        <button @click.stop="deleteExpense(exp.id)" class="w-6 h-6 rounded-full bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-100 transition">
                                            <i class="fa-solid fa-times text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="absolute top-2 right-2 text-[10px] text-slate-300 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-pen"></i></div>
                            </div>
                        </div>
                    </div>
                    <div v-if="Object.keys(filteredExpenseGroups).length === 0" class="text-center text-slate-400 text-sm py-4">
                        Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑË®òÂ∏≥Á¥ÄÈåÑ
                    </div>
                </div>
            </div>
        </main>

        <!-- FAB -->
        <button v-if="selectedTab !== 'todo' && selectedTab !== 'map' && selectedTab !== 'shopping'" @click="openAddModal" class="absolute bottom-24 right-5 w-14 h-14 bg-primaryDark text-white rounded-full shadow-lg shadow-primary/50 flex items-center justify-center text-xl hover:scale-110 active:scale-95 transition z-30">
            <i class="fa-solid fa-plus"></i>
        </button>

        <!-- Nav -->
        <nav class="glass-nav absolute bottom-0 w-full pb-6 pt-3 px-6 shadow-md flex justify-between items-center z-50 rounded-t-3xl">
            <button @click="selectedTab = 'schedule'" :class="selectedTab === 'schedule' ? 'text-primaryDark' : 'text-slate-300'" class="flex flex-col items-center w-12 transition">
                <i class="fa-solid fa-route text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Ë°åÁ®ã</span>
            </button>
            <button @click="selectedTab = 'map'" :class="selectedTab === 'map' ? 'text-primaryDark' : 'text-slate-300'" class="flex flex-col items-center w-12 transition">
                <i class="fa-solid fa-map text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Â∞éËà™</span>
            </button>
            <button @click="selectedTab = 'shopping'" :class="selectedTab === 'shopping' ? 'text-primaryDark' : 'text-slate-300'" class="flex flex-col items-center w-12 transition">
                <i class="fa-solid fa-bag-shopping text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Ë≥ºÁâ©</span>
            </button>
            <button @click="selectedTab = 'wallet'" :class="selectedTab === 'wallet' ? 'text-primaryDark' : 'text-slate-300'" class="flex flex-col items-center w-12 transition">
                <i class="fa-solid fa-wallet text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Ë®òÂ∏≥</span>
            </button>
        </nav>

        <!-- Modals -->

        <!-- Add/Edit Modal (Itinerary & Expenses) -->
        <div v-if="showEditModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closeEditModal">
            
            <!-- Schedule Edit -->
            <div v-if="selectedTab === 'schedule'" class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold text-slate-700 mb-4">{{ modalForm.id ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }}</h3>
                <div class="space-y-4 text-sm">
                    <!-- Type Selection -->
                    <div class="grid grid-cols-4 gap-2">
                        <button v-for="t in ['È£üÁâ©', 'Ë≥ºÁâ©', 'ÊôØÈªû', '‰ΩèÂÆø']" :key="t" 
                            @click="modalForm.type = t"
                            class="py-2 rounded-xl text-xs font-bold border transition"
                            :class="modalForm.type === t ? 'bg-primaryDark text-white border-primaryDark' : 'bg-white text-slate-400 border-slate-200'">
                            {{ t }}
                        </button>
                    </div>

                    <div class="flex space-x-3">
                        <div class="flex-1">
                            <label class="text-xs text-slate-400 ml-1">ÊôÇÈñì</label>
                            <input type="time" v-model="modalForm.time" class="w-full bg-slate-50 rounded-xl px-4 py-3 outline-none text-slate-700 font-mono">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-xs text-slate-400 ml-1">Âú∞ÈªûÂêçÁ®±</label>
                        <input type="text" v-model="modalForm.location" class="w-full bg-slate-50 rounded-xl px-4 py-3 outline-none text-slate-700 font-bold" placeholder="‰æãÂ¶Ç: ÁØâÂú∞Â∏ÇÂ†¥">
                    </div>

                    <div>
                        <label class="text-xs text-slate-400 ml-1">Google Map Á∂≤ÂùÄ (ÈÅ∏Â°´)</label>
                        <input type="text" v-model="modalForm.url" class="w-full bg-slate-50 rounded-xl px-4 py-3 outline-none text-blue-500 text-xs" placeholder="https://maps.app.goo.gl/...">
                    </div>

                    <div>
                        <label class="text-xs text-slate-400 ml-1">ÂÇôË®ª</label>
                        <textarea v-model="modalForm.note" class="w-full bg-slate-50 rounded-xl px-4 py-3 outline-none text-slate-700 h-16 resize-none"></textarea>
                    </div>
                    
                    <!-- Transport Button -->
                    <div class="bg-primary/20 p-4 rounded-xl border border-primary relative">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-primaryDark"><i class="fa-solid fa-route mr-1"></i>‰∫§ÈÄöÂ∞éËà™</label>
                            <button @click="openGoogleMapsRoute" class="text-[10px] bg-white text-primaryDark border border-primary px-2 py-1 rounded-full shadow-sm hover:bg-slate-100 transition flex items-center font-bold">
                                <i class="fa-solid fa-location-arrow mr-1"></i> Á´ãÂç≥Â∞éËà™
                            </button>
                        </div>
                        <p class="text-xs text-slate-600">Ëã•Â°´ÂØ´‰∫ÜÁ∂≤ÂùÄÔºåÂ∞áÂÑ™ÂÖà‰ΩøÁî®Á∂≤ÂùÄÂ∞éËà™ÔºõÂê¶ÂâáÂ∞á‰ª•ÁõÆÂâç‰ΩçÁΩÆÂâçÂæÄ„ÄåÂú∞ÈªûÂêçÁ®±„Äç„ÄÇ</p>
                    </div>
                </div>
                <button @click="saveItineraryItem" class="w-full bg-primaryDark text-white rounded-xl py-3 mt-6 font-bold shadow-lg shadow-primary/50">ÂÑ≤Â≠ò</button>
            </div>

            <!-- Expense Edit -->
            <div v-if="selectedTab === 'wallet'" class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold text-slate-700 mb-4">{{ isEditingExpense ? 'Á∑®ËºØÁ¥ÄÈåÑ' : 'Ë®ò‰∏ä‰∏ÄÁ≠Ü' }} üí∏</h3>
                <div class="space-y-4">
                    <!-- ÊîØ‰ªòÊñπÂºèÈÅ∏È†Ö -->
                    <div>
                        <label class="text-xs text-slate-400 ml-1 mb-1 block">ÊîØ‰ªòÊñπÂºè</label>
                        <div class="grid grid-cols-3 gap-2">
                            <label v-for="method in ['ÁèæÈáë', '‰ø°Áî®Âç°', 'ÈõªÂ≠êÊîØ‰ªò']" :key="method" class="cursor-pointer text-center">
                                <input type="radio" v-model="expenseForm.paymentMethod" :value="method" class="hidden peer">
                                <div class="py-2 rounded-lg text-xs font-bold text-slate-500 bg-slate-100 peer-checked:bg-blue-100 peer-checked:text-blue-600 transition">{{ method }}</div>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-slate-400 ml-1 mb-1 block">Ë™∞‰ªòÈå¢Ôºü</label>
                        <div class="grid grid-cols-4 gap-2">
                            <label v-for="m in members" :key="m" class="cursor-pointer text-center">
                                <input type="radio" v-model="expenseForm.payer" :value="m" class="hidden peer">
                                <div class="py-2 rounded-lg text-xs font-bold text-slate-500 bg-slate-100 peer-checked:bg-primaryDark peer-checked:text-white transition" :class="'member-badge-'+m">{{ m }}</div>
                            </label>
                        </div>
                    </div>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <label class="flex-1 cursor-pointer text-center">
                            <input type="radio" v-model="expenseForm.currency" value="JPY" class="hidden peer">
                            <div class="py-2 rounded-lg text-sm font-bold text-slate-500 peer-checked:bg-primary peer-checked:text-white transition">Êó•Âπ£ (JPY)</div>
                        </label>
                        <label class="flex-1 cursor-pointer text-center">
                            <input type="radio" v-model="expenseForm.currency" value="TWD" class="hidden peer">
                            <div class="py-2 rounded-lg text-sm font-bold text-slate-500 peer-checked:bg-primary peer-checked:text-white transition">Âè∞Âπ£ (TWD)</div>
                        </label>
                    </div>
                    <div class="relative">
                        <span class="absolute left-4 top-3 text-slate-400 font-bold">{{ expenseForm.currency === 'JPY' ? '¬•' : '$' }}</span>
                        <input type="number" v-model="expenseForm.amount" placeholder="ÈáëÈ°ç" class="w-full bg-slate-50 rounded-xl pl-8 pr-4 py-3 outline-none text-xl font-bold text-slate-700 border border-slate-100 focus:border-primaryDark">
                    </div>
                    <p v-if="expenseForm.paymentMethod === '‰ø°Áî®Âç°'" class="text-xs text-red-400 text-right">Â∞áËá™ÂãïÂä†Êî∂ 1.5% ÊâãÁ∫åË≤ª</p>
                    
                    <input type="text" v-model="expenseForm.title" placeholder="È†ÖÁõÆ" class="w-full bg-slate-50 rounded-xl px-4 py-3 outline-none text-slate-700 border border-slate-100 focus:border-primaryDark">
                    <div>
                        <label class="text-xs text-slate-400 ml-1">Êó•Êúü</label>
                        <select v-model="expenseForm.date" class="w-full bg-slate-50 rounded-xl px-4 py-3 outline-none text-slate-700 border border-slate-100 focus:border-primaryDark">
                            <option v-for="d in dates" :value="d.date">{{ d.date }} ({{ d.weekday }})</option>
                        </select>
                    </div>
                </div>
                <button @click="saveExpense" class="w-full bg-primaryDark text-white rounded-xl py-3 mt-6 font-bold shadow-lg shadow-primary/50">{{ isEditingExpense ? 'Êõ¥Êñ∞' : 'Êñ∞Â¢û' }}</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue; 

        // üö® ÈÄôÊòØÊÇ®ÂµåÂÖ•ÁöÑ Firebase Config üö®
        const MANUAL_CONFIG_OBJECT = {
          apiKey: "AIzaSyALhfxIv4MsLPxjfLeOYfyG2VfeD3XjFPI",
          authDomain: "chiba-1981c.firebaseapp.com",
          projectId: "chiba-1981c",
          storageBucket: "chiba-1981c.firebasestorage.app",
          messagingSenderId: "361035054636",
          appId: "1:361035054636:web:2d682857fd8399dc651b89",
          measurementId: "G-QZLJQ7Q2RQ"
        };
        // üö® ÂµåÂÖ•ÁµêÊùü üö®

        const EXCHANGE_API_KEY = 'da94a2508c3cd2c1d8730ab0b573f463';
        const appId = 'Chiba-Travel-App'; 
        const firebaseConfig = MANUAL_CONFIG_OBJECT || (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let tripDocRef;

        const initializeFirebase = async () => {
            if (!firebaseConfig) return { db: null, auth: null, userId: 'CONFIG_MISSING' };
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            try {
                if (MANUAL_CONFIG_OBJECT) await signInAnonymously(auth);
                else if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);
                const userId = auth.currentUser?.uid || crypto.randomUUID();
                tripDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', 'chiba_trip_data');
                return { db, auth, userId };
            } catch (error) {
                return { db, auth, userId: 'anon-' + crypto.randomUUID().substring(0, 8) };
            }
        };

        createApp({
            setup() {
                const members = ['Catty', 'Tony', 'Tina', 'Anita'];
                
                const selectedTab = ref('schedule');
                const selectedDateIndex = ref(0);
                const showShoppingModal = ref(false);
                const showEditModal = ref(false);
                const exchangeRate = ref(0.218); 
                const exchangeRateDate = ref('');
                const currentMapLocation = ref('');
                const shoppingFilterOwner = ref(''); 
                const editingShoppingId = ref(null); 
                const expenseFilterDate = ref(''); // New filter state
                
                const isAuthReady = ref(false);
                const isDataReady = ref(false);
                const userId = ref('...');
                const isEditingExpense = ref(false);

                const dates = [
                    { date: '2025/12/18', weekday: 'ÈÄ±Âõõ' },
                    { date: '2025/12/19', weekday: 'ÈÄ±‰∫î' },
                    { date: '2025/12/20', weekday: 'ÈÄ±ÂÖ≠' },
                    { date: '2025/12/21', weekday: 'ÈÄ±Êó•' },
                    { date: '2025/12/22', weekday: 'ÈÄ±‰∏Ä' },
                ];
                
                const itinerary = ref([]);
                const expenses = ref([]);
                const todoList = ref([]);
                const shoppingList = ref([]);
                
                // Initial Data Setup
                const getDefaultData = () => ({
                    itinerary: [
                        { id: 1, date: '2025/12/18', time: '02:30', location: 'Ê°ÉÂúíÁ¨¨‰∏ÄËà™Âªà', type: 'ÊôØÈªû', url: '', note: 'Ëà™Áè≠GK12' },
                        { id: 2, date: '2025/12/18', time: '06:35', location: 'ÊàêÁî∞Á¨¨‰∏âËà™Âªà', type: 'ÊôØÈªû', url: '', note: 'ÈôçËêΩ' },
                    ],
                    expenses: [],
                    todoList: [],
                    shoppingList: [],
                    exchangeRate: 0.218,
                    exchangeRateDate: ''
                });
                
                const newTodoText = ref('');
                const newShoppingItem = ref({ text: '', price: '', owner: members[0], url: '', quantity: 1 });
                const modalForm = ref({ id: null, time: '10:00', location: '', type: 'ÊôØÈªû', url: '', note: '' }); 
                const expenseForm = ref({ id: null, date: dates[0].date, amount: '', title: '', currency: 'JPY', payer: members[0], paymentMethod: 'ÁèæÈáë' });
                
                // Firebase Logic
                const startRealtimeListener = () => {
                    if (!tripDocRef) return;
                    onSnapshot(tripDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            itinerary.value = JSON.parse(JSON.stringify(data.itinerary || []));
                            expenses.value = JSON.parse(JSON.stringify(data.expenses || []));
                            todoList.value = JSON.parse(JSON.stringify(data.todoList || []));
                            shoppingList.value = JSON.parse(JSON.stringify(data.shoppingList || []));
                            exchangeRate.value = data.exchangeRate || 0.218;
                            exchangeRateDate.value = data.exchangeRateDate || '';
                            checkAndUpdateRate();
                        } else {
                            const def = getDefaultData();
                            runTransaction(db, async (t) => {
                                const f = await t.get(tripDocRef);
                                if(!f.exists()) t.set(tripDocRef, {...def, createdAt: serverTimestamp()});
                            });
                        }
                        isDataReady.value = true;
                    });
                };

                const saveData = async () => {
                    if (!tripDocRef) return;
                    await setDoc(tripDocRef, {
                        itinerary: itinerary.value,
                        expenses: expenses.value,
                        todoList: todoList.value,
                        shoppingList: shoppingList.value,
                        exchangeRate: exchangeRate.value,
                        exchangeRateDate: exchangeRateDate.value,
                        updatedAt: serverTimestamp()
                    });
                };

                async function fetchWithBackoff(url, retries = 3, delay = 1000) {
                    for (let i = 0; i < retries; i++) {
                        try {
                            const response = await fetch(url);
                            if (!response.ok) throw new Error(`HTTP status: ${response.status}`);
                            return await response.json();
                        } catch (error) {
                            if (i === retries - 1) throw error;
                            await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                        }
                    }
                }

                const checkAndUpdateRate = async () => {
                     const today = new Date().toLocaleDateString('zh-TW');
                     if (exchangeRateDate.value === today) return; 
                     try {
                         const url = `https://v6.exchangerate-api.com/v6/${EXCHANGE_API_KEY}/latest/JPY`;
                         const res = await fetchWithBackoff(url);
                         if (res?.conversion_rates?.TWD) {
                             exchangeRate.value = res.conversion_rates.TWD * 1.015;
                             exchangeRateDate.value = today;
                             saveData(); 
                         } else {
                            const fallbackRes = await fetchWithBackoff('https://api.exchangerate-api.com/v4/latest/JPY');
                             if (fallbackRes?.rates?.TWD) {
                                 exchangeRate.value = fallbackRes.rates.TWD * 1.015;
                                 exchangeRateDate.value = today;
                                 saveData(); 
                             }
                         }
                     } catch (e) { console.error('Auto-update rate failed', e); }
                };
                
                // Computed
                const currentDateDisplay = computed(() => dates[selectedDateIndex.value].date);
                const currentDayItinerary = computed(() => {
                    const d = dates[selectedDateIndex.value].date;
                    return itinerary.value.filter(i => i.date === d).sort((a,b) => a.time.localeCompare(b.time));
                });

                const filteredShoppingList = computed(() => {
                    const sorted = [...shoppingList.value].sort((a, b) => Number(a.done) - Number(b.done));
                    if (!shoppingFilterOwner.value) return sorted;
                    return sorted.filter(item => item.owner === shoppingFilterOwner.value);
                });
                
                const currentFilteredShoppingTotalJPY = computed(() => {
                    return filteredShoppingList.value.reduce((sum, item) => sum + ((parseFloat(item.price)||0) * (parseInt(item.quantity)||0)), 0);
                });

                const currentFilteredShoppingTotalTWD = computed(() => {
                    return Math.round(currentFilteredShoppingTotalJPY.value * exchangeRate.value).toLocaleString();
                });
                
                const currentMapUrl = computed(() => {
                    const locations = currentDayItinerary.value.map(item => item.location).join('+and+');
                    if (locations.length > 0) return `https://maps.google.com/maps?q=${encodeURIComponent(locations)}&t=&z=11&ie=UTF8&iwloc=&output=embed`;
                    return `https://www.google.com/maps/d/embed?mid=1P71Wk_k8Y7a2tX9q0s-x6w?hl=zh-TW`;
                });

                // New Computed for Filtered Expenses
                const filteredExpensesList = computed(() => {
                    if (!expenseFilterDate.value) return expenses.value;
                    return expenses.value.filter(e => e.date === expenseFilterDate.value);
                });

                const filteredExpenseGroups = computed(() => {
                    const groups = {};
                    filteredExpensesList.value.forEach(exp => {
                        if (!groups[exp.date]) groups[exp.date] = { items: [], totalTWD: 0 };
                        groups[exp.date].items.push(exp);
                        const amt = exp.currency === 'JPY' ? (exp.amount * exchangeRate.value) : parseInt(exp.amount);
                        groups[exp.date].totalTWD += amt;
                    });
                    return groups;
                });

                const filteredExpenseTotalTWD = computed(() => {
                    return filteredExpensesList.value.reduce((sum, item) => {
                        return sum + (item.currency === 'JPY' ? (item.amount * exchangeRate.value) : parseInt(item.amount));
                    }, 0).toFixed(0);
                });

                // Update getMemberTotal to respect filter
                const getMemberTotal = (member) => {
                    return filteredExpensesList.value.filter(e => e.payer === member).reduce((sum, item) => {
                        return sum + (item.currency === 'JPY' ? (item.amount * exchangeRate.value) : parseInt(item.amount));
                    }, 0).toFixed(0);
                };

                // Methods
                const startNavigation = (item) => {
                    let url = '';
                    if (item.url && item.url.startsWith('http')) {
                         url = item.url;
                    } else {
                         const dest = item.location;
                         if (!dest) return;
                         url = `https://www.google.com/maps/dir/?api=1&origin=Current+Location&destination=${encodeURIComponent(dest)}&travelmode=transit`;
                    }
                    window.open(url, '_blank');
                };
                
                const openGoogleMapsRoute = () => {
                    if (modalForm.value.url && modalForm.value.url.startsWith('http')) {
                        window.open(modalForm.value.url, '_blank');
                        return;
                    }
                    const dest = modalForm.value.location;
                    if (!dest) return alert("Ë´ãËº∏ÂÖ•Âú∞Èªû");
                    window.open(`https://www.google.com/maps/dir/?api=1&origin=Current+Location&destination=${encodeURIComponent(dest)}&travelmode=transit`, '_blank');
                };

                const selectDate = (idx) => {
                    selectedTab.value = 'schedule';
                    selectedDateIndex.value = idx;
                    currentMapLocation.value = '';
                };

                // Itinerary Logic
                const openAddModal = () => {
                    if (selectedTab.value === 'schedule') {
                        modalForm.value = { id: null, time: '10:00', location: '', type: 'ÊôØÈªû', url: '', note: '' };
                    } else if (selectedTab.value === 'wallet') {
                        isEditingExpense.value = false;
                        expenseForm.value = { id: null, date: dates[selectedDateIndex.value].date, amount: '', title: '', currency: 'JPY', payer: members[0], paymentMethod: 'ÁèæÈáë' };
                    }
                    showEditModal.value = true;
                };

                const closeEditModal = () => showEditModal.value = false;
                
                const editItem = (item) => {
                    modalForm.value = JSON.parse(JSON.stringify(item));
                    showEditModal.value = true;
                };
                
                const saveItineraryItem = async () => {
                    const itemToSave = { ...modalForm.value, date: dates[selectedDateIndex.value].date };
                    if (itemToSave.id) {
                        const idx = itinerary.value.findIndex(i => i.id === itemToSave.id);
                        if (idx !== -1) itinerary.value[idx] = itemToSave;
                    } else {
                        itemToSave.id = Date.now();
                        itinerary.value.push(itemToSave);
                    }
                    await saveData();
                    closeEditModal();
                };

                const deleteItem = (id) => {
                    if(confirm('Âà™Èô§Ôºü')) {
                        itinerary.value = itinerary.value.filter(i => i.id !== id);
                        saveData();
                    }
                };

                // Expense Logic
                const editExpense = (exp) => {
                    isEditingExpense.value = true;
                    expenseForm.value = JSON.parse(JSON.stringify(exp));
                    if (!expenseForm.value.paymentMethod) expenseForm.value.paymentMethod = 'ÁèæÈáë'; // default for old data
                    showEditModal.value = true;
                };

                const saveExpense = async () => {
                    if(!expenseForm.value.amount || !expenseForm.value.title) return;
                    
                    // Calculate Fee Logic: If Credit Card, multiply by 1.015
                    let finalAmount = parseFloat(expenseForm.value.amount);
                    if (expenseForm.value.paymentMethod === '‰ø°Áî®Âç°') {
                        finalAmount = finalAmount * 1.015;
                    }

                    const expToSave = { 
                        ...expenseForm.value,
                        amount: finalAmount
                    };
                    
                    if (expToSave.id) {
                         const idx = expenses.value.findIndex(e => e.id === expToSave.id);
                         if (idx !== -1) expenses.value[idx] = expToSave;
                    } else {
                         expToSave.id = Date.now();
                         expenses.value.unshift(expToSave);
                    }
                    await saveData();
                    closeEditModal();
                };

                const deleteExpense = (id) => {
                    if(confirm('Âà™Èô§Á¥ÄÈåÑÔºü')) {
                        expenses.value = expenses.value.filter(e => e.id !== id);
                        saveData();
                    }
                };

                // Shopping Logic
                const editShoppingItem = (item) => {
                    newShoppingItem.value = JSON.parse(JSON.stringify(item));
                    editingShoppingId.value = item; 
                };

                const cancelShoppingEdit = () => {
                    editingShoppingId.value = null;
                    newShoppingItem.value = { text: '', price: '', owner: members[0], url: '', quantity: 1 };
                };

                const addOrUpdateShoppingItem = () => {
                    if(!newShoppingItem.value.text) return;
                    
                    const payload = { ...newShoppingItem.value };
                    
                    if (editingShoppingId.value) {
                        const idx = shoppingList.value.indexOf(editingShoppingId.value);
                        if (idx !== -1) {
                            shoppingList.value[idx] = payload;
                        }
                    } else {
                        shoppingList.value.unshift({ ...payload, done: false }); // Add to top
                    }
                    saveData();
                    cancelShoppingEdit();
                };

                const removeShoppingItem = (item) => {
                    const idx = shoppingList.value.indexOf(item);
                    if (idx !== -1) {
                        shoppingList.value.splice(idx, 1);
                        saveData();
                    }
                };

                const removeTodo = (i) => { todoList.value.splice(i, 1); saveData(); };
                const addTodo = () => { if(newTodoText.value) { todoList.value.push({text: newTodoText.value, status: {Catty:false, Tony:false, Tina:false, Anita:false}}); newTodoText.value=''; saveData(); } };

                const getTypeIcon = (t) => ({'È£üÁâ©':'üçú','Ë≥ºÁâ©':'üõçÔ∏è','ÊôØÈªû':'üì∑','‰ΩèÂÆø':'üè®'}[t]||'üìç');
                const getTypeClass = (t) => ({'È£üÁâ©':'type-food','Ë≥ºÁâ©':'type-shop','ÊôØÈªû':'type-spot','‰ΩèÂÆø':'type-stay'}[t]||'bg-slate-100 text-slate-500');
                
                const getPaymentBadgeClass = (m) => ({'ÁèæÈáë':'pay-cash','‰ø°Áî®Âç°':'pay-card','ÈõªÂ≠êÊîØ‰ªò':'pay-epay'}[m]||'pay-cash');

                const updateMapLocation = (loc) => currentMapLocation.value = loc;
                const locateMe = () => {
                    if (navigator.geolocation) navigator.geolocation.getCurrentPosition(p => { currentMapLocation.value = `${p.coords.latitude},${p.coords.longitude}`; alert('Â∑≤ÂÆö‰Ωç'); });
                };

                onMounted(async () => { 
                    if (userId.value === 'CONFIG_MISSING') { isAuthReady.value=true; isDataReady.value=true; return; }
                    const fb = await initializeFirebase();
                    userId.value = fb.userId;
                    isAuthReady.value = true;
                    startRealtimeListener();
                });

                return {
                    members, selectedTab, selectedDateIndex, dates, itinerary, expenses, todoList, shoppingList,
                    newTodoText, newShoppingItem, modalForm, expenseForm, showShoppingModal, showEditModal, exchangeRate, exchangeRateDate,
                    currentDateDisplay, currentDayItinerary, expenseGroups: filteredExpenseGroups, totalExpenseTWD: filteredExpenseTotalTWD, currentMapLocation, currentMapUrl,
                    shoppingFilterOwner, filteredShoppingList, currentFilteredShoppingTotalJPY, currentFilteredShoppingTotalTWD,
                    expenseFilterDate, filteredExpensesList, filteredExpenseGroups, filteredExpenseTotalTWD,
                    selectDate, openAddModal, closeEditModal, editItem, saveItineraryItem, deleteItem,
                    saveExpense, editExpense, deleteExpense, addTodo, removeTodo, isEditingExpense,
                    addOrUpdateShoppingItem, editShoppingItem, cancelShoppingEdit, removeShoppingItem, editingShoppingId,
                    getTypeIcon, getTypeClass, getPaymentBadgeClass, locateMe, updateMapLocation, startNavigation, openGoogleMapsRoute, getMemberTotal, saveData,
                    isAuthReady, isDataReady, userId, appId 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
